<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iuran KKG PAI Kecamatan Nagreg</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f1f5f9;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-3: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
            --shadow-lg: 0 25px 50px rgba(0,0,0,0.15);
        }

        body {
            background: var(--light);
            min-height: 100vh;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            margin-top: 20px;
            color: var(--dark);
            font-weight: 600;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .login-container::before,
        .login-container::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            animation: float 6s ease-in-out infinite;
        }

        .login-container::before {
            width: 400px;
            height: 400px;
            top: -100px;
            right: -100px;
        }

        .login-container::after {
            width: 300px;
            height: 300px;
            bottom: -50px;
            left: -50px;
            animation-delay: -3s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(10deg); }
        }

        .login-box {
            background: white;
            padding: 50px 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 440px;
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-logo {
            text-align: center;
            margin-bottom: 35px;
        }

        .login-logo .icon-wrapper {
            width: 100px;
            height: 100px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-logo .icon-wrapper i {
            font-size: 45px;
            color: white;
        }

        .login-logo h1 {
            font-size: 28px;
            color: var(--dark);
            font-weight: 700;
        }

        .login-logo p {
            color: #64748b;
            font-size: 14px;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--dark);
            font-weight: 600;
            font-size: 14px;
        }

        .input-group {
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 18px;
        }

        .form-control {
            width: 100%;
            padding: 16px 16px 16px 50px;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-success { background: var(--gradient-2); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: #64748b; color: white; }

        .btn-sm {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 10px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 10px;
        }

        .login-hint {
            margin-top: 25px;
            padding: 18px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 14px;
            border-left: 4px solid var(--info);
        }

        .login-hint p {
            font-size: 13px;
            color: #0369a1;
            margin-bottom: 8px;
        }

        .login-hint .hint-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            margin-top: 8px;
        }

        .login-hint .hint-item i {
            color: var(--primary);
        }

        .login-hint code {
            background: #e0f2fe;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        /* Dashboard */
        .dashboard { display: none; }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 25px 20px;
            overflow-y: auto;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            text-align: center;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 25px;
        }

        .sidebar-header .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
        }

        .sidebar-header .logo-icon i {
            font-size: 32px;
            color: white;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 8px;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(99, 102, 241, 0.2);
            color: white;
        }

        .nav-menu a.active {
            background: var(--gradient);
        }

        .nav-menu a i {
            width: 22px;
            font-size: 18px;
        }

        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 20px 0;
        }

        .nav-menu .admin-only {
            display: none;
        }

        .nav-menu.is-admin .admin-only {
            display: block;
        }

        .main-content {
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Running Text */
        .running-text-container {
            background: var(--gradient);
            padding: 15px 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .running-text-icon {
            font-size: 24px;
            margin-right: 20px;
            flex-shrink: 0;
        }

        .running-text-wrapper {
            overflow: hidden;
            flex: 1;
        }

        .running-text {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 35s linear infinite;
        }

        .running-text span {
            color: white;
            font-weight: 500;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .running-text-container:hover .running-text {
            animation-play-state: paused;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-header h1 {
            font-size: 28px;
            color: var(--dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-header h1 i {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: var(--shadow);
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .user-avatar.member {
            background: var(--gradient-2);
        }

        .user-details h4 {
            font-size: 14px;
            color: var(--dark);
        }

        .user-details p {
            font-size: 12px;
            color: #64748b;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card .icon {
            width: 55px;
            height: 55px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-card.kas .icon { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .stat-card.member .icon { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .stat-card.paid .icon { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-card.unpaid .icon { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .stat-card h3 {
            font-size: 26px;
            color: var(--dark);
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #64748b;
            font-size: 14px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
        }

        .card-header h2 {
            font-size: 18px;
            color: var(--dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-header h2 i {
            color: var(--primary);
        }

        .card-body {
            padding: 25px;
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 600;
            color: var(--dark);
            font-size: 13px;
            text-transform: uppercase;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Badges */
        .badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-asn {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .badge-non-asn {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-lunas {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
        }

        .badge-belum {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-admin {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }

        .badge-member {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
        }

        /* Member Profile Card */
        .profile-card {
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .profile-header {
            background: var(--gradient);
            padding: 40px;
            text-align: center;
            color: white;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            font-weight: 700;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .profile-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .profile-header p {
            opacity: 0.9;
        }

        .profile-body {
            padding: 30px;
        }

        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-info-item {
            padding: 20px;
            background: #f8fafc;
            border-radius: 14px;
        }

        .profile-info-item label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            display: block;
            margin-bottom: 8px;
        }

        .profile-info-item span {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Member Payment Summary */
        .payment-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            text-align: center;
            padding: 25px;
            border-radius: 16px;
            background: #f8fafc;
        }

        .summary-card.total {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .summary-card.paid {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }

        .summary-card.remaining {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .summary-card h4 {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
        }

        .summary-card.paid .value { color: var(--secondary); }
        .summary-card.remaining .value { color: var(--danger); }

        /* Month Grid */
        .months-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .month-btn {
            padding: 15px 10px;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .month-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.2);
        }

        .month-btn.paid {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: var(--secondary);
            cursor: default;
        }

        .month-btn.paid::after {
            content: 'âœ“';
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 12px;
            color: var(--secondary);
            font-weight: bold;
        }

        .month-btn .month-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            display: block;
        }

        .month-btn .month-amount {
            font-size: 11px;
            color: #64748b;
            margin-top: 3px;
            display: block;
        }

        .month-btn.paid .month-name,
        .month-btn.paid .month-amount {
            color: #065f46;
        }

        /* Member view - non clickable */
        .month-btn.member-view {
            cursor: default;
        }

        .month-btn.member-view:hover {
            transform: none;
            box-shadow: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalPop 0.4s ease;
        }

        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%);
            border-radius: 24px 24px 0 0;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header h2 i {
            color: var(--primary);
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: #fafbfc;
            border-radius: 0 0 24px 24px;
        }

        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 18px center;
            padding-right: 45px;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Toggle */
        .toggle-container {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 18px;
            background: #f8fafc;
            border-radius: 14px;
        }

        .toggle {
            position: relative;
            width: 56px;
            height: 30px;
            flex-shrink: 0;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #cbd5e1;
            border-radius: 30px;
            transition: 0.4s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.4s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle input:checked + .toggle-slider {
            background: var(--gradient-2);
        }

        .toggle input:checked + .toggle-slider::before {
            transform: translateX(26px);
        }

        /* Search Filter */
        .search-filter {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-filter input,
        .search-filter select {
            padding: 12px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .search-filter input:focus,
        .search-filter select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Year Tabs */
        .year-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .year-tab {
            padding: 12px 28px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .year-tab:hover {
            border-color: var(--primary);
        }

        .year-tab.active {
            background: var(--gradient);
            color: white;
            border-color: transparent;
        }

        /* Mobile */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 50px;
            height: 50px;
            background: var(--gradient);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 3000;
        }

        .toast {
            background: white;
            padding: 18px 25px;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: toastIn 0.4s ease;
            min-width: 300px;
        }

        @keyframes toastIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left: 5px solid var(--secondary); }
        .toast.error { border-left: 5px solid var(--danger); }
        .toast.warning { border-left: 5px solid var(--warning); }
        .toast.info { border-left: 5px solid var(--info); }

        .toast i { font-size: 24px; }
        .toast.success i { color: var(--secondary); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        .toast.info i { color: var(--info); }

        /* Admin List */
        .admin-list {
            display: grid;
            gap: 15px;
        }

        .admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .admin-item:hover {
            background: white;
            box-shadow: var(--shadow);
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 55px;
            height: 55px;
            background: var(--gradient);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 22px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 70px;
            margin-bottom: 20px;
            color: #cbd5e1;
        }

        .empty-state h3 {
            font-size: 20px;
            color: var(--dark);
            margin-bottom: 10px;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Confirm Modal */
        .confirm-content {
            text-align: center;
            padding: 30px;
        }

        .confirm-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
        }

        .confirm-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .confirm-icon.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .confirm-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }

        .confirm-content h3 {
            font-size: 22px;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .confirm-content p {
            color: #64748b;
            line-height: 1.6;
        }

        /* Member Payment Card */
        .member-payment-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .member-payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .member-info-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .member-avatar-sm {
            width: 50px;
            height: 50px;
            background: var(--gradient);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .member-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .member-stat {
            text-align: center;
            padding: 10px 18px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .member-stat .value {
            font-size: 16px;
            font-weight: 700;
        }

        .member-stat .label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-left: 0; padding: 80px 20px 30px; }
            .menu-toggle { display: flex; align-items: center; justify-content: center; }
        }

        @media (max-width: 576px) {
            .login-box { padding: 35px 25px; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .page-header h1 { font-size: 22px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .months-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }
            .month-btn { padding: 12px 8px; }
            .month-btn .month-name { font-size: 12px; }
            .month-btn .month-amount { font-size: 9px; }
            th, td { padding: 10px 8px; font-size: 12px; }
        }

        @media print {
            .sidebar, .menu-toggle, .btn, .modal, .toast-container, .running-text-container { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 20px !important; }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text">Memuat aplikasi...</p>
    </div>

    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Page -->
    <div class="login-container" id="loginPage" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <div class="icon-wrapper">
                    <i class="fas fa-mosque"></i>
                </div>
                <h1>KKG PAI</h1>
                <p>Kecamatan Nagreg</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> User ID (No HP)</label>
                    <div class="input-group">
                        <i class="fas fa-mobile-alt"></i>
                        <input type="text" class="form-control" id="loginPhone" placeholder="Masukkan User ID" required>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password (NRG)</label>
                    <div class="input-group">
                        <i class="fas fa-key"></i>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Masukkan Password" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Masuk
                </button>
            </form>
            <div class="login-hint">
                <p><i class="fas fa-info-circle"></i> <strong>Cara Login:</strong></p>
                <div class="hint-item">
                    <i class="fas fa-user-shield"></i>
                    <span><strong>Admin:</strong> User ID & Password dari admin</span>
                </div>
                <div class="hint-item">
                    <i class="fas fa-user"></i>
                    <span><strong>Anggota:</strong> No HP & NRG yang terdaftar</span>
                </div>
                <p style="margin-top: 12px; font-size: 12px;">
                    Default Admin: <code>admin</code> / <code>admin123</code>
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="fas fa-mosque"></i>
                </div>
                <h2>KKG PAI Nagreg</h2>
                <p>Sistem Iuran Digital</p>
            </div>
            <ul class="nav-menu" id="navMenu">
                <!-- Menu untuk Anggota -->
                <li class="member-menu"><a href="#" class="nav-link active" data-section="profile-section"><i class="fas fa-user"></i> Profil Saya</a></li>
                <li class="member-menu"><a href="#" class="nav-link" data-section="my-payment-section"><i class="fas fa-money-bill-wave"></i> Pembayaran Saya</a></li>
                
                <!-- Menu untuk Admin -->
                <li class="admin-only"><a href="#" class="nav-link active" data-section="dashboard-section"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="members-section"><i class="fas fa-users"></i> Data Anggota</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="payments-section"><i class="fas fa-money-bill-wave"></i> Pembayaran</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="allocations-section"><i class="fas fa-chart-pie"></i> Alokasi Dana</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="reports-section"><i class="fas fa-file-invoice-dollar"></i> Laporan</a></li>
                <div class="nav-divider admin-only"></div>
                <li class="admin-only"><a href="#" class="nav-link" data-section="admins-section"><i class="fas fa-user-shield"></i> Kelola Admin</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="settings-section"><i class="fas fa-cogs"></i> Pengaturan</a></li>
                <div class="nav-divider"></div>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <!-- Running Text -->
            <div class="running-text-container" id="runningTextContainer">
                <span class="running-text-icon">ðŸ“¢</span>
                <div class="running-text-wrapper">
                    <div class="running-text">
                        <span id="runningTextContent">Selamat datang di Sistem Iuran KKG PAI Kecamatan Nagreg ðŸŽ‰</span>
                    </div>
                </div>
            </div>

            <!-- ============ MEMBER SECTIONS ============ -->
            
            <!-- Profile Section (Member) -->
            <section class="section" id="profile-section">
                <div class="page-header">
                    <h1><i class="fas fa-user"></i> Profil Saya</h1>
                    <div class="user-info">
                        <div class="user-details">
                            <h4 id="profileName">-</h4>
                            <p><span class="badge badge-member"><i class="fas fa-user"></i> Anggota</span></p>
                        </div>
                        <div class="user-avatar member" id="profileAvatar">A</div>
                    </div>
                </div>

                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatarLarge">A</div>
                        <h2 id="profileNameLarge">-</h2>
                        <p id="profileStatus">-</p>
                    </div>
                    <div class="profile-body">
                        <div class="profile-info">
                            <div class="profile-info-item">
                                <label><i class="fas fa-phone"></i> No HP</label>
                                <span id="profilePhone">-</span>
                            </div>
                            <div class="profile-info-item">
                                <label><i class="fas fa-id-card"></i> NRG</label>
                                <span id="profileNRG">-</span>
                            </div>
                            <div class="profile-info-item">
                                <label><i class="fas fa-building"></i> Status</label>
                                <span id="profileStatusBadge">-</span>
                            </div>
                            <div class="profile-info-item">
                                <label><i class="fas fa-school"></i> Sekolah</label>
                                <span id="profileSchool">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- My Payment Section (Member) -->
            <section class="section" id="my-payment-section">
                <div class="page-header">
                    <h1><i class="fas fa-money-bill-wave"></i> Pembayaran Saya</h1>
                </div>

                <div class="year-tabs" id="memberYearTabs"></div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-calendar-check"></i> Status Iuran Tahun <span id="memberYearLabel">2024</span></h2>
                    </div>
                    <div class="card-body">
                        <div class="payment-summary" id="memberPaymentSummary"></div>
                        <h4 style="margin-bottom: 15px; color: var(--dark);"><i class="fas fa-calendar"></i> Detail Per Bulan</h4>
                        <div class="months-grid" id="memberMonthsGrid"></div>
                    </div>
                </div>
            </section>

            <!-- ============ ADMIN SECTIONS ============ -->

            <!-- Dashboard Section -->
            <section class="section" id="dashboard-section">
                <div class="page-header">
                    <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                    <div class="user-info">
                        <div class="user-details">
                            <h4 id="welcomeUser">Administrator</h4>
                            <p><span class="badge badge-admin"><i class="fas fa-shield-alt"></i> Admin</span></p>
                        </div>
                        <div class="user-avatar" id="userAvatar">A</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card kas">
                        <div class="icon"><i class="fas fa-wallet"></i></div>
                        <h3 id="totalKas">Rp 0</h3>
                        <p>Saldo KAS KKG</p>
                    </div>
                    <div class="stat-card member">
                        <div class="icon"><i class="fas fa-users"></i></div>
                        <h3 id="totalMember">0</h3>
                        <p>Total Anggota</p>
                    </div>
                    <div class="stat-card paid">
                        <div class="icon"><i class="fas fa-check-double"></i></div>
                        <h3 id="totalLunas">0</h3>
                        <p>Sudah Lunas</p>
                    </div>
                    <div class="stat-card unpaid">
                        <div class="icon"><i class="fas fa-clock"></i></div>
                        <h3 id="totalBelumLunas">0</h3>
                        <p>Belum Lunas</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> Aktivitas Terakhir</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Waktu</th>
                                        <th>Nama</th>
                                        <th>Bulan</th>
                                        <th>Nominal</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivities"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Members Section -->
            <section class="section" id="members-section">
                <div class="page-header">
                    <h1><i class="fas fa-users"></i> Data Anggota</h1>
                    <button class="btn btn-primary btn-sm" onclick="openModal('addMemberModal')">
                        <i class="fas fa-user-plus"></i> Tambah Anggota
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> Daftar Anggota</h2>
                        <div class="search-filter">
                            <input type="text" id="searchMember" placeholder="ðŸ” Cari nama..." oninput="renderMembers()">
                            <select id="filterStatus" onchange="renderMembers()">
                                <option value="">Semua Status</option>
                                <option value="ASN">ASN</option>
                                <option value="Non ASN">Non ASN</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama</th>
                                        <th>No HP</th>
                                        <th>NRG</th>
                                        <th>Status</th>
                                        <th>Sekolah</th>
                                        <th>Progress</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="membersList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section class="section" id="payments-section">
                <div class="page-header">
                    <h1><i class="fas fa-money-bill-wave"></i> Pembayaran Iuran</h1>
                </div>

                <div class="year-tabs" id="yearTabs"></div>

                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body" style="padding: 18px;">
                        <div class="search-filter">
                            <input type="text" id="searchPayment" placeholder="ðŸ” Cari nama..." style="flex: 1;" oninput="renderPaymentCards()">
                            <select id="filterPaymentStatus" onchange="renderPaymentCards()">
                                <option value="">Semua</option>
                                <option value="lunas">Sudah Lunas</option>
                                <option value="belum">Belum Lunas</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="paymentCardsContainer"></div>
            </section>

            <!-- Allocations Section -->
            <section class="section" id="allocations-section">
                <div class="page-header">
                    <h1><i class="fas fa-chart-pie"></i> Alokasi Dana</h1>
                    <button class="btn btn-primary btn-sm" onclick="openModal('addAllocationModal')">
                        <i class="fas fa-plus-circle"></i> Tambah Pengeluaran
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card kas">
                        <div class="icon"><i class="fas fa-arrow-down"></i></div>
                        <h3 id="totalIncome">Rp 0</h3>
                        <p>Total Pemasukan</p>
                    </div>
                    <div class="stat-card unpaid">
                        <div class="icon"><i class="fas fa-arrow-up"></i></div>
                        <h3 id="totalExpense">Rp 0</h3>
                        <p>Total Pengeluaran</p>
                    </div>
                    <div class="stat-card member">
                        <div class="icon"><i class="fas fa-piggy-bank"></i></div>
                        <h3 id="remainingKas">Rp 0</h3>
                        <p>Sisa KAS</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-receipt"></i> Riwayat Pengeluaran</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Tanggal</th>
                                        <th>Keterangan</th>
                                        <th>Nominal</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="allocationsList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section class="section" id="reports-section">
                <div class="page-header">
                    <h1><i class="fas fa-file-invoice-dollar"></i> Laporan</h1>
                    <button class="btn btn-primary btn-sm" onclick="window.print()">
                        <i class="fas fa-print"></i> Cetak
                    </button>
                </div>
                <div id="reportContent"></div>
            </section>

            <!-- Admins Section -->
            <section class="section" id="admins-section">
                <div class="page-header">
                    <h1><i class="fas fa-user-shield"></i> Kelola Admin</h1>
                    <button class="btn btn-primary btn-sm" onclick="openModal('addAdminModal')">
                        <i class="fas fa-user-plus"></i> Tambah Admin
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-users-cog"></i> Daftar Admin</h2>
                    </div>
                    <div class="card-body">
                        <div class="admin-list" id="adminsList"></div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="section" id="settings-section">
                <div class="page-header">
                    <h1><i class="fas fa-cogs"></i> Pengaturan</h1>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-sliders-h"></i> Pengaturan Aplikasi</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label><i class="fas fa-bullhorn"></i> Running Text</label>
                            <textarea class="form-control" id="settingRunningText" rows="3" style="padding: 15px;"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-money-bill"></i> Iuran ASN (per bulan)</label>
                                <div class="input-group">
                                    <i class="fas fa-rupiah-sign"></i>
                                    <input type="number" class="form-control" id="settingIuranASN" value="50000">
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-money-bill"></i> Iuran Non ASN (per bulan)</label>
                                <div class="input-group">
                                    <i class="fas fa-rupiah-sign"></i>
                                    <input type="number" class="form-control" id="settingIuranNonASN" value="25000">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Tahun Aktif</label>
                            <div class="input-group">
                                <i class="fas fa-calendar-alt"></i>
                                <input type="number" class="form-control" id="settingActiveYear" value="2024">
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="toggle-container">
                                <label class="toggle">
                                    <input type="checkbox" id="settingShowUnpaid" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <div>
                                    <strong>Tampilkan Belum Lunas di Running Text</strong>
                                    <p style="font-size: 13px; color: #64748b; margin-top: 3px;">Nama anggota yang belum lunas akan ditampilkan</p>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-success" onclick="saveSettings()" style="margin-top: 10px;">
                            <i class="fas fa-save"></i> Simpan Pengaturan
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Add Member Modal -->
    <div class="modal" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Tambah Anggota</h2>
                <button class="modal-close" onclick="closeModal('addMemberModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nama Lengkap *</label>
                    <input type="text" class="form-control" id="memberName" style="padding-left: 15px;" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nomor HP * (untuk login)</label>
                        <input type="text" class="form-control" id="memberPhone" style="padding-left: 15px;" required>
                    </div>
                    <div class="form-group">
                        <label>NRG * (sebagai password)</label>
                        <input type="text" class="form-control" id="memberNRG" style="padding-left: 15px;" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status *</label>
                        <select class="form-control" id="memberStatus" style="padding-left: 15px;" required>
                            <option value="">Pilih Status</option>
                            <option value="ASN">ASN</option>
                            <option value="Non ASN">Non ASN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sekolah *</label>
                        <input type="text" class="form-control" id="memberSchool" style="padding-left: 15px;" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closeModal('addMemberModal')">Batal</button>
                <button class="btn btn-success btn-sm" onclick="saveMember()"><i class="fas fa-save"></i> Simpan</button>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div class="modal" id="editMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Edit Anggota</h2>
                <button class="modal-close" onclick="closeModal('editMemberModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editMemberId">
                <div class="form-group">
                    <label>Nama Lengkap *</label>
                    <input type="text" class="form-control" id="editMemberName" style="padding-left: 15px;" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nomor HP *</label>
                        <input type="text" class="form-control" id="editMemberPhone" style="padding-left: 15px;" required>
                    </div>
                    <div class="form-group">
                        <label>NRG *</label>
                        <input type="text" class="form-control" id="editMemberNRG" style="padding-left: 15px;" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status *</label>
                        <select class="form-control" id="editMemberStatus" style="padding-left: 15px;" required>
                            <option value="ASN">ASN</option>
                            <option value="Non ASN">Non ASN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sekolah *</label>
                        <input type="text" class="form-control" id="editMemberSchool" style="padding-left: 15px;" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closeModal('editMemberModal')">Batal</button>
                <button class="btn btn-success btn-sm" onclick="updateMember()"><i class="fas fa-save"></i> Update</button>
            </div>
        </div>
    </div>

    <!-- Add Admin Modal -->
    <div class="modal" id="addAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-shield"></i> Tambah Admin</h2>
                <button class="modal-close" onclick="closeModal('addAdminModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nama Admin *</label>
                    <input type="text" class="form-control" id="adminName" style="padding-left: 15px;" required>
                </div>
                <div class="form-group">
                    <label>User ID (No HP) *</label>
                    <input type="text" class="form-control" id="adminPhone" style="padding-left: 15px;" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="text" class="form-control" id="adminPassword" style="padding-left: 15px;" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closeModal('addAdminModal')">Batal</button>
                <button class="btn btn-success btn-sm" onclick="saveAdmin()"><i class="fas fa-save"></i> Simpan</button>
            </div>
        </div>
    </div>

    <!-- Add Allocation Modal -->
    <div class="modal" id="addAllocationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Tambah Pengeluaran</h2>
                <button class="modal-close" onclick="closeModal('addAllocationModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tanggal *</label>
                    <input type="date" class="form-control" id="allocationDate" style="padding-left: 15px;" required>
                </div>
                <div class="form-group">
                    <label>Keterangan *</label>
                    <input type="text" class="form-control" id="allocationDesc" style="padding-left: 15px;" placeholder="Contoh: Konsumsi rapat, ATK, dll" required>
                </div>
                <div class="form-group">
                    <label>Nominal *</label>
                    <input type="number" class="form-control" id="allocationAmount" style="padding-left: 15px;" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closeModal('addAllocationModal')">Batal</button>
                <button class="btn btn-success btn-sm" onclick="saveAllocation()"><i class="fas fa-save"></i> Simpan</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="confirm-content">
                <div class="confirm-icon" id="confirmIcon"><i class="fas fa-question"></i></div>
                <h3 id="confirmTitle">Konfirmasi</h3>
                <p id="confirmMessage">Apakah Anda yakin?</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-secondary btn-sm" onclick="closeModal('confirmModal')">Batal</button>
                <button class="btn btn-success btn-sm" id="confirmBtn">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyA03kLjLZ_YrT6gBwmX7-f-3YZmLvdNtoc",
  authDomain: "iuran-kkg.firebaseapp.com",
  projectId: "iuran-kkg",
  storageBucket: "iuran-kkg.firebasestorage.app",
  messagingSenderId: "1073355365967",
  appId: "1:1073355365967:web:0d367824dc1c64d35d143a",
  measurementId: "G-93R57Y0PYD"
};


        let db;
        let firebaseConnected = false;

        // Global Data
        let currentUser = null;
        let members = [];
        let payments = [];
        let allocations = [];
        let admins = [];
        let selectedYear = new Date().getFullYear();
        let memberSelectedYear = new Date().getFullYear();

        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
        const FULL_MONTHS = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        let settings = {
            runningText: "Selamat datang di Sistem Iuran KKG PAI Kecamatan Nagreg ðŸŽ‰",
            iuranASN: 50000,
            iuranNonASN: 25000,
            showUnpaid: true,
            activeYear: new Date().getFullYear()
        };

        // Init
        document.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                await testConnection();
                
                if (firebaseConnected) {
                    await loadAdmins();
                    await loadMembers();
                    
                    if (admins.length === 0) {
                        await createDefaultAdmin();
                    }
                    
                    await loadSettings();
                }
                
                setupEventListeners();
                initYearTabs();
                initMemberYearTabs();
                
            } catch (error) {
                console.error('Init error:', error);
                showToast('Gagal koneksi ke Firebase!', 'error');
            } finally {
                hideLoading();
                document.getElementById('loginPage').style.display = 'flex';
            }
        }

        async function testConnection() {
            try {
                await db.collection('_test').doc('_test').get();
                firebaseConnected = true;
            } catch (error) {
                console.error('Connection failed:', error);
                firebaseConnected = false;
            }
        }

        async function createDefaultAdmin() {
            try {
                await db.collection('admins').doc('default').set({
                    name: 'Administrator',
                    phone: 'admin',
                    nrg: 'admin123',
                    createdAt: new Date().toISOString()
                });
                await loadAdmins();
            } catch (error) {
                console.error('Error creating admin:', error);
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', handleNavigation);
            });
            
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });

            document.getElementById('allocationDate').value = new Date().toISOString().split('T')[0];
        }

        // ============ LOGIN/LOGOUT ============
        async function handleLogin(e) {
            e.preventDefault();
            
            if (!firebaseConnected) {
                showToast('Firebase tidak terhubung!', 'error');
                return;
            }

            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // Check admin first
            const admin = admins.find(a => a.phone === phone && a.nrg === password);
            if (admin) {
                currentUser = { ...admin, role: 'admin' };
                await showDashboard();
                showToast(`Selamat datang, ${admin.name}!`, 'success');
                return;
            }
            
            // Check member
            const member = members.find(m => m.phone === phone && m.nrg === password);
            if (member) {
                currentUser = { ...member, role: 'member' };
                await showDashboard();
                showToast(`Selamat datang, ${member.name}!`, 'success');
                return;
            }
            
            showToast('User ID atau Password salah!', 'error');
        }

        function handleLogout(e) {
            e.preventDefault();
            currentUser = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginForm').reset();
            
            // Reset menu visibility
            document.querySelectorAll('.admin-only, .member-menu').forEach(el => {
                el.style.display = 'none';
            });
            
            showToast('Anda telah keluar', 'info');
        }

        async function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            const isAdmin = currentUser.role === 'admin';
            
            // Show/hide menu based on role
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? 'block' : 'none';
            });
            
            document.querySelectorAll('.member-menu').forEach(el => {
                el.style.display = isAdmin ? 'none' : 'block';
            });
            
            // Set active section
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            if (isAdmin) {
                document.getElementById('dashboard-section').classList.add('active');
                document.querySelector('[data-section="dashboard-section"]').classList.add('active');
                document.getElementById('welcomeUser').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            } else {
                document.getElementById('profile-section').classList.add('active');
                document.querySelector('[data-section="profile-section"]').classList.add('active');
                renderMemberProfile();
            }
            
            await loadAllData();
        }

        // ============ NAVIGATION ============
        function handleNavigation(e) {
            e.preventDefault();
            const section = this.dataset.section;
            if (!section) return;

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');

            closeSidebar();
            
            // Refresh member payment if needed
            if (section === 'my-payment-section') {
                renderMemberPayment();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        // ============ DATA LOADING ============
        async function loadAllData() {
            if (!firebaseConnected) return;
            
            await Promise.all([
                loadMembers(),
                loadPayments(),
                loadAllocations()
            ]);
            
            if (currentUser?.role === 'admin') {
                updateDashboard();
                generateReport();
            } else {
                renderMemberProfile();
                renderMemberPayment();
            }
            
            updateRunningText();
        }

        async function loadAdmins() {
            if (!firebaseConnected) return;
            try {
                const snapshot = await db.collection('admins').get();
                admins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdmins();
            } catch (error) {
                console.error('Error loading admins:', error);
            }
        }

        async function loadMembers() {
            if (!firebaseConnected) return;
            try {
                const snapshot = await db.collection('members').orderBy('name').get();
                members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMembers();
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        async function loadPayments() {
            if (!firebaseConnected) return;
            try {
                const snapshot = await db.collection('payments').orderBy('createdAt', 'desc').get();
                payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPaymentCards();
                renderRecentActivities();
                
                if (currentUser?.role === 'member') {
                    renderMemberPayment();
                }
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        async function loadAllocations() {
            if (!firebaseConnected) return;
            try {
                const snapshot = await db.collection('allocations').orderBy('date', 'desc').get();
                allocations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllocations();
            } catch (error) {
                console.error('Error loading allocations:', error);
            }
        }

        async function loadSettings() {
            if (!firebaseConnected) return;
            try {
                const doc = await db.collection('settings').doc('app').get();
                if (doc.exists) {
                    settings = { ...settings, ...doc.data() };
                }
                applySettings();
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function applySettings() {
            document.getElementById('settingRunningText').value = settings.runningText;
            document.getElementById('settingIuranASN').value = settings.iuranASN;
            document.getElementById('settingIuranNonASN').value = settings.iuranNonASN;
            document.getElementById('settingActiveYear').value = settings.activeYear;
            document.getElementById('settingShowUnpaid').checked = settings.showUnpaid;
            selectedYear = settings.activeYear;
            memberSelectedYear = settings.activeYear;
        }

        // ============ YEAR TABS ============
        function initYearTabs() {
            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];
            
            document.getElementById('yearTabs').innerHTML = years.map(year => `
                <button class="year-tab ${year === selectedYear ? 'active' : ''}" onclick="selectYear(${year})">${year}</button>
            `).join('');
        }

        function initMemberYearTabs() {
            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];
            
            document.getElementById('memberYearTabs').innerHTML = years.map(year => `
                <button class="year-tab ${year === memberSelectedYear ? 'active' : ''}" onclick="selectMemberYear(${year})">${year}</button>
            `).join('');
        }

        function selectYear(year) {
            selectedYear = year;
            document.querySelectorAll('#yearTabs .year-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.textContent) === year);
            });
            renderPaymentCards();
        }

        function selectMemberYear(year) {
            memberSelectedYear = year;
            document.getElementById('memberYearLabel').textContent = year;
            document.querySelectorAll('#memberYearTabs .year-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.textContent) === year);
            });
            renderMemberPayment();
        }

        // ============ MEMBER PROFILE & PAYMENT ============
        function renderMemberProfile() {
            if (!currentUser || currentUser.role !== 'member') return;
            
            const m = currentUser;
            const initial = m.name.charAt(0).toUpperCase();
            
            document.getElementById('profileName').textContent = m.name;
            document.getElementById('profileAvatar').textContent = initial;
            document.getElementById('profileAvatarLarge').textContent = initial;
            document.getElementById('profileNameLarge').textContent = m.name;
            document.getElementById('profileStatus').textContent = m.status;
            document.getElementById('profilePhone').textContent = m.phone;
            document.getElementById('profileNRG').textContent = m.nrg;
            document.getElementById('profileStatusBadge').innerHTML = `<span class="badge badge-${m.status === 'ASN' ? 'asn' : 'non-asn'}">${m.status}</span>`;
            document.getElementById('profileSchool').textContent = m.school;
        }

        function renderMemberPayment() {
            if (!currentUser || currentUser.role !== 'member') return;
            
            const m = currentUser;
            const iuranPerMonth = m.status === 'ASN' ? settings.iuranASN : settings.iuranNonASN;
            const totalIuran = iuranPerMonth * 12;
            
            // Get paid months for selected year
            const memberPayments = payments.filter(p => 
                p.memberId === m.id && 
                p.monthKey && 
                p.monthKey.startsWith(String(memberSelectedYear))
            );
            const paidMonths = memberPayments.map(p => p.monthKey);
            const totalPaid = memberPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const remaining = Math.max(0, totalIuran - totalPaid);
            
            // Summary
            document.getElementById('memberPaymentSummary').innerHTML = `
                <div class="summary-card total">
                    <h4>Total Iuran ${memberSelectedYear}</h4>
                    <div class="value">${formatRupiah(totalIuran)}</div>
                </div>
                <div class="summary-card paid">
                    <h4>Sudah Dibayar</h4>
                    <div class="value">${formatRupiah(totalPaid)}</div>
                </div>
                <div class="summary-card remaining">
                    <h4>Sisa Tagihan</h4>
                    <div class="value">${remaining > 0 ? formatRupiah(remaining) : 'âœ“ LUNAS'}</div>
                </div>
            `;
            
            // Months grid (view only)
            document.getElementById('memberMonthsGrid').innerHTML = MONTHS.map((month, index) => {
                const monthKey = `${memberSelectedYear}-${String(index + 1).padStart(2, '0')}`;
                const isPaid = paidMonths.includes(monthKey);
                
                return `
                    <div class="month-btn member-view ${isPaid ? 'paid' : ''}">
                        <span class="month-name">${month}</span>
                        <span class="month-amount">${formatRupiah(iuranPerMonth)}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('memberYearLabel').textContent = memberSelectedYear;
        }

        // ============ ADMIN RENDERS ============
        function renderAdmins() {
            const container = document.getElementById('adminsList');
            if (admins.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-user-shield"></i><h3>Belum ada admin</h3></div>';
                return;
            }

            container.innerHTML = admins.map(admin => `
                <div class="admin-item">
                    <div class="admin-info">
                        <div class="admin-avatar">${admin.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <h4>${admin.name}</h4>
                            <p style="font-size: 13px; color: #64748b;"><i class="fas fa-user"></i> ${admin.phone} | <i class="fas fa-key"></i> ${admin.nrg}</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="badge badge-admin"><i class="fas fa-shield-alt"></i> Admin</span>
                        ${admins.length > 1 ? `<button class="btn btn-danger btn-icon" onclick="confirmDelete('admin', '${admin.id}', '${admin.name}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderMembers() {
            const search = (document.getElementById('searchMember')?.value || '').toLowerCase();
            const status = document.getElementById('filterStatus')?.value || '';
            
            let filtered = members.filter(m => {
                const matchSearch = m.name.toLowerCase().includes(search);
                const matchStatus = !status || m.status === status;
                return matchSearch && matchStatus;
            });

            const tbody = document.getElementById('membersList');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-users"></i><h3>Tidak ada anggota</h3></div></td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map((member, i) => {
                const { paid, total } = getMemberPaymentStats(member.id);
                const progress = total > 0 ? Math.round((paid / total) * 100) : 0;

                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${member.name}</strong></td>
                        <td>${member.phone}</td>
                        <td>${member.nrg}</td>
                        <td><span class="badge badge-${member.status === 'ASN' ? 'asn' : 'non-asn'}">${member.status}</span></td>
                        <td>${member.school}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; min-width: 50px;">
                                    <div style="height: 100%; width: ${progress}%; background: ${progress >= 100 ? 'var(--secondary)' : 'var(--primary)'}; border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 11px; font-weight: 600;">${progress}%</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-info btn-icon" onclick="editMember('${member.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-icon" onclick="confirmDelete('member', '${member.id}', '${member.name}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPaymentCards() {
            const search = (document.getElementById('searchPayment')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('filterPaymentStatus')?.value || '';

            let filtered = members.filter(m => m.name.toLowerCase().includes(search));

            if (statusFilter) {
                filtered = filtered.filter(m => {
                    const { paid, total } = getMemberPaymentStats(m.id);
                    return statusFilter === 'lunas' ? paid >= total : paid < total;
                });
            }

            const container = document.getElementById('paymentCardsContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><h3>Tidak ada data</h3></div>';
                return;
            }

            container.innerHTML = filtered.map(member => {
                const iuranPerMonth = member.status === 'ASN' ? settings.iuranASN : settings.iuranNonASN;
                const { paid, paidMonths } = getMemberPaymentStats(member.id);
                const total = iuranPerMonth * 12;
                const remaining = Math.max(0, total - paid);

                return `
                    <div class="member-payment-card">
                        <div class="member-payment-header">
                            <div class="member-info-row">
                                <div class="member-avatar-sm">${member.name.charAt(0).toUpperCase()}</div>
                                <div>
                                    <h3 style="font-size: 16px; color: var(--dark);">${member.name}</h3>
                                    <p style="font-size: 12px; color: #64748b;">
                                        <span class="badge badge-${member.status === 'ASN' ? 'asn' : 'non-asn'}">${member.status}</span>
                                        ${member.school}
                                    </p>
                                </div>
                            </div>
                            <div class="member-stats">
                                <div class="member-stat">
                                    <div class="value" style="color: var(--secondary);">${formatRupiah(paid)}</div>
                                    <div class="label">Terbayar</div>
                                </div>
                                <div class="member-stat">
                                    <div class="value" style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--secondary)'};">
                                        ${remaining > 0 ? formatRupiah(remaining) : 'âœ“ LUNAS'}
                                    </div>
                                    <div class="label">Sisa</div>
                                </div>
                                <div class="member-stat">
                                    <div class="value">${paidMonths.length}/12</div>
                                    <div class="label">Bulan</div>
                                </div>
                            </div>
                        </div>
                        <div class="months-grid">
                            ${MONTHS.map((month, index) => {
                                const monthKey = `${selectedYear}-${String(index + 1).padStart(2, '0')}`;
                                const isPaid = paidMonths.includes(monthKey);
                                return `
                                    <button class="month-btn ${isPaid ? 'paid' : ''}" onclick="togglePayment('${member.id}', '${monthKey}', ${isPaid}, ${iuranPerMonth}, '${member.name}')">
                                        <span class="month-name">${month}</span>
                                        <span class="month-amount">${formatRupiahShort(iuranPerMonth)}</span>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAllocations() {
            const totalPayments = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalAllocated = allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
            
            document.getElementById('totalIncome').textContent = formatRupiah(totalPayments);
            document.getElementById('totalExpense').textContent = formatRupiah(totalAllocated);
            document.getElementById('remainingKas').textContent = formatRupiah(totalPayments - totalAllocated);

            const tbody = document.getElementById('allocationsList');
            
            if (allocations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fas fa-receipt"></i><h3>Belum ada pengeluaran</h3></div></td></tr>`;
                return;
            }

            tbody.innerHTML = allocations.map((alloc, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${formatDate(alloc.date)}</td>
                    <td>${alloc.description}</td>
                    <td><strong style="color: var(--danger);">- ${formatRupiah(alloc.amount)}</strong></td>
                    <td><button class="btn btn-danger btn-icon" onclick="confirmDelete('allocation', '${alloc.id}', '${alloc.description}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function renderRecentActivities() {
            const tbody = document.getElementById('recentActivities');
            const recent = payments.slice(0, 10);

            if (recent.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state" style="padding: 30px;"><i class="fas fa-inbox"></i><p>Belum ada pembayaran</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = recent.map(payment => {
                const member = members.find(m => m.id === payment.memberId);
                const [year, month] = (payment.monthKey || '').split('-');
                const monthName = month ? FULL_MONTHS[parseInt(month) - 1] : '';

                return `
                    <tr>
                        <td>${formatDateTime(payment.createdAt)}</td>
                        <td><strong>${member?.name || 'Unknown'}</strong></td>
                        <td>${monthName} ${year || ''}</td>
                        <td><span style="color: var(--secondary); font-weight: 600;">+ ${formatRupiah(payment.amount)}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ============ PAYMENT FUNCTIONS ============
        function getMemberPaymentStats(memberId) {
            const memberPayments = payments.filter(p => 
                p.memberId === memberId && 
                p.monthKey && 
                p.monthKey.startsWith(String(selectedYear))
            );
            const paid = memberPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const paidMonths = memberPayments.map(p => p.monthKey);
            const member = members.find(m => m.id === memberId);
            const iuranPerMonth = member?.status === 'ASN' ? settings.iuranASN : settings.iuranNonASN;
            const total = iuranPerMonth * 12;
            
            return { paid, total, paidMonths };
        }

        function togglePayment(memberId, monthKey, isPaid, amount, memberName) {
            const [year, month] = monthKey.split('-');
            const monthName = FULL_MONTHS[parseInt(month) - 1];

            if (isPaid) {
                showConfirmModal(
                    'warning',
                    'Batalkan Pembayaran?',
                    `Batalkan pembayaran <strong>${memberName}</strong> bulan <strong>${monthName} ${year}</strong>?`,
                    () => cancelPayment(memberId, monthKey)
                );
            } else {
                showConfirmModal(
                    'success',
                    'Konfirmasi Pembayaran',
                    `Catat pembayaran <strong>${memberName}</strong> bulan <strong>${monthName} ${year}</strong> sebesar <strong>${formatRupiah(amount)}</strong>?`,
                    () => processPayment(memberId, monthKey, amount)
                );
            }
        }

        async function processPayment(memberId, monthKey, amount) {
            closeModal('confirmModal');
            
            try {
                await db.collection('payments').add({
                    memberId,
                    monthKey,
                    amount,
                    year: selectedYear,
                    createdAt: new Date().toISOString()
                });

                await loadPayments();
                updateDashboard();
                updateRunningText();
                
                const member = members.find(m => m.id === memberId);
                showToast(`Pembayaran ${member?.name} berhasil!`, 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan pembayaran', 'error');
            }
        }

        async function cancelPayment(memberId, monthKey) {
            closeModal('confirmModal');
            
            try {
                const snapshot = await db.collection('payments')
                    .where('memberId', '==', memberId)
                    .where('monthKey', '==', monthKey)
                    .get();

                for (const doc of snapshot.docs) {
                    await doc.ref.delete();
                }

                await loadPayments();
                updateDashboard();
                updateRunningText();
                showToast('Pembayaran dibatalkan', 'warning');
            } catch (error) {
                console.error(error);
                showToast('Gagal membatalkan pembayaran', 'error');
            }
        }

        // ============ CRUD OPERATIONS ============
        async function saveMember() {
            const data = {
                name: document.getElementById('memberName').value.trim(),
                phone: document.getElementById('memberPhone').value.trim(),
                nrg: document.getElementById('memberNRG').value.trim(),
                status: document.getElementById('memberStatus').value,
                school: document.getElementById('memberSchool').value.trim()
            };

            if (!data.name || !data.phone || !data.nrg || !data.status || !data.school) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            // Check if phone already exists
            if (members.some(m => m.phone === data.phone)) {
                showToast('No HP sudah terdaftar!', 'error');
                return;
            }

            try {
                await db.collection('members').add({
                    ...data,
                    createdAt: new Date().toISOString()
                });

                closeModal('addMemberModal');
                document.getElementById('memberName').value = '';
                document.getElementById('memberPhone').value = '';
                document.getElementById('memberNRG').value = '';
                document.getElementById('memberStatus').value = '';
                document.getElementById('memberSchool').value = '';
                
                await loadMembers();
                renderPaymentCards();
                updateDashboard();
                showToast('Anggota berhasil ditambahkan! Bisa login dengan No HP & NRG', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan anggota', 'error');
            }
        }

        function editMember(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;

            document.getElementById('editMemberId').value = id;
            document.getElementById('editMemberName').value = member.name;
            document.getElementById('editMemberPhone').value = member.phone;
            document.getElementById('editMemberNRG').value = member.nrg;
            document.getElementById('editMemberStatus').value = member.status;
            document.getElementById('editMemberSchool').value = member.school;

            openModal('editMemberModal');
        }

        async function updateMember() {
            const id = document.getElementById('editMemberId').value;
            const data = {
                name: document.getElementById('editMemberName').value.trim(),
                phone: document.getElementById('editMemberPhone').value.trim(),
                nrg: document.getElementById('editMemberNRG').value.trim(),
                status: document.getElementById('editMemberStatus').value,
                school: document.getElementById('editMemberSchool').value.trim()
            };

            try {
                await db.collection('members').doc(id).update(data);
                closeModal('editMemberModal');
                await loadMembers();
                renderPaymentCards();
                showToast('Data berhasil diupdate!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal mengupdate data', 'error');
            }
        }

        function confirmDelete(type, id, name) {
            showConfirmModal(
                'danger',
                'Hapus Data?',
                `Apakah Anda yakin ingin menghapus <strong>${name}</strong>?`,
                () => executeDelete(type, id)
            );
        }

        async function executeDelete(type, id) {
            closeModal('confirmModal');
            
            try {
                if (type === 'member') {
                    await db.collection('members').doc(id).delete();
                    const paymentSnapshot = await db.collection('payments').where('memberId', '==', id).get();
                    for (const doc of paymentSnapshot.docs) {
                        await doc.ref.delete();
                    }
                    await loadMembers();
                    await loadPayments();
                } else if (type === 'allocation') {
                    await db.collection('allocations').doc(id).delete();
                    await loadAllocations();
                } else if (type === 'admin') {
                    await db.collection('admins').doc(id).delete();
                    await loadAdmins();
                }
                
                updateDashboard();
                showToast('Data berhasil dihapus', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menghapus data', 'error');
            }
        }

        async function saveAdmin() {
            const data = {
                name: document.getElementById('adminName').value.trim(),
                phone: document.getElementById('adminPhone').value.trim(),
                nrg: document.getElementById('adminPassword').value.trim()
            };

            if (!data.name || !data.phone || !data.nrg) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            if (admins.some(a => a.phone === data.phone)) {
                showToast('User ID sudah digunakan!', 'error');
                return;
            }

            try {
                await db.collection('admins').add({
                    ...data,
                    createdAt: new Date().toISOString()
                });

                closeModal('addAdminModal');
                document.getElementById('adminName').value = '';
                document.getElementById('adminPhone').value = '';
                document.getElementById('adminPassword').value = '';
                await loadAdmins();
                showToast('Admin berhasil ditambahkan!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan admin', 'error');
            }
        }

        async function saveAllocation() {
            const data = {
                date: document.getElementById('allocationDate').value,
                description: document.getElementById('allocationDesc').value.trim(),
                amount: parseInt(document.getElementById('allocationAmount').value)
            };

            if (!data.date || !data.description || !data.amount) {
                showToast('Semua field harus diisi!', 'error');
                return;
            }

            const totalPayments = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalAllocated = allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
            
            if (data.amount > (totalPayments - totalAllocated)) {
                showToast('Saldo KAS tidak mencukupi!', 'error');
                return;
            }

            try {
                await db.collection('allocations').add({
                    ...data,
                    createdAt: new Date().toISOString()
                });

                closeModal('addAllocationModal');
                document.getElementById('allocationDesc').value = '';
                document.getElementById('allocationAmount').value = '';
                await loadAllocations();
                updateDashboard();
                showToast('Pengeluaran berhasil dicatat!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan pengeluaran', 'error');
            }
        }

        async function saveSettings() {
            settings.runningText = document.getElementById('settingRunningText').value;
            settings.iuranASN = parseInt(document.getElementById('settingIuranASN').value);
            settings.iuranNonASN = parseInt(document.getElementById('settingIuranNonASN').value);
            settings.activeYear = parseInt(document.getElementById('settingActiveYear').value);
            settings.showUnpaid = document.getElementById('settingShowUnpaid').checked;

            try {
                await db.collection('settings').doc('app').set(settings);
                selectedYear = settings.activeYear;
                memberSelectedYear = settings.activeYear;
                initYearTabs();
                initMemberYearTabs();
                updateRunningText();
                renderPaymentCards();
                renderMembers();
                updateDashboard();
                showToast('Pengaturan berhasil disimpan!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan pengaturan', 'error');
            }
        }

        // ============ UPDATE FUNCTIONS ============
        function updateDashboard() {
            const totalPayments = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalAllocated = allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
            
            let lunasCount = 0;
            let belumLunasCount = 0;

            members.forEach(member => {
                const { paid, total } = getMemberPaymentStats(member.id);
                if (paid >= total) lunasCount++;
                else belumLunasCount++;
            });

            document.getElementById('totalKas').textContent = formatRupiah(totalPayments - totalAllocated);
            document.getElementById('totalMember').textContent = members.length;
            document.getElementById('totalLunas').textContent = lunasCount;
            document.getElementById('totalBelumLunas').textContent = belumLunasCount;
        }

        function updateRunningText() {
            let text = settings.runningText;

            if (settings.showUnpaid) {
                const unpaidList = [];
                members.forEach(member => {
                    const { paid, total } = getMemberPaymentStats(member.id);
                    if (paid < total) {
                        unpaidList.push(`${member.name} (${formatRupiah(total - paid)})`);
                    }
                });

                if (unpaidList.length > 0) {
                    text += ` âš ï¸ BELUM LUNAS: ${unpaidList.join(' â€¢ ')}`;
                }
            }

            document.getElementById('runningTextContent').textContent = text;
        }

        function generateReport() {
            const totalPayments = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalAllocated = allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
            const kas = totalPayments - totalAllocated;

            let lunasCount = 0;
            let belumLunasList = [];

            members.forEach(member => {
                const { paid, total } = getMemberPaymentStats(member.id);
                if (paid >= total) lunasCount++;
                else belumLunasList.push({ name: member.name, remaining: total - paid });
            });

            document.getElementById('reportContent').innerHTML = `
                <div class="card">
                    <div class="card-body" style="text-align: center; padding: 40px;">
                        <h2><i class="fas fa-mosque" style="color: var(--primary);"></i> LAPORAN KEUANGAN</h2>
                        <h3 style="color: var(--primary);">KKG PAI KECAMATAN NAGREG</h3>
                        <p style="color: #64748b;">Tahun ${selectedYear}</p>
                    </div>
                </div>

                <div class="stats-grid" style="margin: 25px 0;">
                    <div class="stat-card kas">
                        <div class="icon"><i class="fas fa-arrow-down"></i></div>
                        <h3>${formatRupiah(totalPayments)}</h3>
                        <p>Total Pemasukan</p>
                    </div>
                    <div class="stat-card unpaid">
                        <div class="icon"><i class="fas fa-arrow-up"></i></div>
                        <h3>${formatRupiah(totalAllocated)}</h3>
                        <p>Total Pengeluaran</p>
                    </div>
                    <div class="stat-card member">
                        <div class="icon"><i class="fas fa-wallet"></i></div>
                        <h3>${formatRupiah(kas)}</h3>
                        <p>Saldo KAS</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-users"></i> Statistik</h2></div>
                    <div class="card-body">
                        <table>
                            <tr><td>Total Anggota</td><td><strong>${members.length}</strong></td></tr>
                            <tr><td>Sudah Lunas</td><td><span class="badge badge-lunas">${lunasCount}</span></td></tr>
                            <tr><td>Belum Lunas</td><td><span class="badge badge-belum">${belumLunasList.length}</span></td></tr>
                        </table>
                    </div>
                </div>
            `;
        }

        // ============ UTILITY ============
        function formatRupiah(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num || 0);
        }

        function formatRupiahShort(num) {
            return num >= 1000 ? 'Rp' + (num / 1000) + 'K' : formatRupiah(num);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showConfirmModal(type, title, message, onConfirm) {
            const icons = { success: 'fa-check-circle', danger: 'fa-exclamation-triangle', warning: 'fa-question-circle' };
            document.getElementById('confirmIcon').className = `confirm-icon ${type}`;
            document.getElementById('confirmIcon').innerHTML = `<i class="fas ${icons[type]}"></i>`;
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').innerHTML = message;
            document.getElementById('confirmBtn').className = `btn btn-${type === 'danger' ? 'danger' : 'success'} btn-sm`;
            document.getElementById('confirmBtn').onclick = onConfirm;
            openModal('confirmModal');
        }

        function showToast(message, type = 'success') {
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toastIn 0.4s ease reverse';
                setTimeout(() => toast.remove(), 400);
            }, 4000);
        }
    </script>
</body>
</html>
