<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iuran KKG PAI Kecamatan Nagreg</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600;700&family=Raleway:wght@300;400;500;600;700&family=Quicksand:wght@300;400;500;600;700&family=Nunito:wght@300;400;500;600;700;800&family=Lobster&family=Pacifico&family=Dancing+Script:wght@400;500;600;700&family=Satisfy&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --dark: #1e293b; --light: #f1f5f9;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-3: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-4: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-5: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --shadow: 0 10px 40px rgba(0,0,0,0.1); --shadow-lg: 0 25px 50px rgba(0,0,0,0.15);
        }
        body { background: var(--light); min-height: 100vh; }

        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 60px; height: 60px; border: 5px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; color: var(--dark); font-weight: 600; }

        /* Login */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--gradient); padding: 20px; position: relative; overflow: hidden; }
        .login-container::before, .login-container::after { content: ''; position: absolute; border-radius: 50%; background: rgba(255,255,255,0.1); animation: float 6s ease-in-out infinite; }
        .login-container::before { width: 400px; height: 400px; top: -100px; right: -100px; }
        .login-container::after { width: 300px; height: 300px; bottom: -50px; left: -50px; animation-delay: -3s; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-30px) rotate(10deg); } }
        .login-box { background: white; padding: 50px 40px; border-radius: 24px; box-shadow: var(--shadow-lg); width: 100%; max-width: 440px; position: relative; z-index: 1; animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        .login-logo { text-align: center; margin-bottom: 35px; }
        .login-logo .icon-wrapper { width: 100px; height: 100px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .login-logo .icon-wrapper i { font-size: 45px; color: white; }
        .login-logo h1 { font-size: 28px; color: var(--dark); font-weight: 700; }
        .login-logo p { color: #64748b; font-size: 14px; margin-top: 5px; }

        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 10px; color: var(--dark); font-weight: 600; font-size: 14px; }
        .input-group { position: relative; }
        .input-group i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 18px; }
        .form-control { width: 100%; padding: 16px 16px 16px 50px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 16px; transition: all 0.3s ease; background: #f8fafc; }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .form-control.no-icon { padding-left: 16px; }

        .btn { padding: 16px 32px; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-primary { background: var(--gradient); color: white; width: 100%; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4); }
        .btn-success { background: var(--gradient-2); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-sm { padding: 10px 20px; font-size: 14px; border-radius: 10px; }
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 10px; }

        .login-hint { margin-top: 25px; padding: 18px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 14px; border-left: 4px solid var(--info); }
        .login-hint p { font-size: 13px; color: #0369a1; margin-bottom: 8px; }
        .login-hint .hint-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: white; border-radius: 8px; margin-top: 8px; }
        .login-hint .hint-item i { color: var(--primary); }
        .login-hint code { background: #e0f2fe; padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; }

        /* Dashboard */
        .dashboard { display: none; }
        .sidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); color: white; padding: 25px 20px; overflow-y: auto; z-index: 1000; transition: all 0.3s ease; }
        .sidebar-header { text-align: center; padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px; }
        .sidebar-header .logo-icon { width: 70px; height: 70px; background: var(--gradient); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; }
        .sidebar-header .logo-icon i { font-size: 32px; color: white; }
        .sidebar-header h2 { font-size: 18px; font-weight: 700; }
        .sidebar-header p { font-size: 12px; color: #94a3b8; margin-top: 5px; }
        .nav-menu { list-style: none; }
        .nav-menu li { margin-bottom: 8px; }
        .nav-menu a { display: flex; align-items: center; gap: 14px; padding: 14px 18px; color: #94a3b8; text-decoration: none; border-radius: 12px; transition: all 0.3s ease; font-weight: 500; }
        .nav-menu a:hover, .nav-menu a.active { background: rgba(99, 102, 241, 0.2); color: white; }
        .nav-menu a.active { background: var(--gradient); }
        .nav-menu a i { width: 22px; font-size: 18px; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0; }
        .admin-only, .member-menu { display: none; }

        .main-content { margin-left: 280px; padding: 30px; min-height: 100vh; transition: all 0.3s ease; }

        /* Running Text */
        .running-text-container { background: var(--gradient); padding: 15px 25px; border-radius: 16px; margin-bottom: 30px; overflow: hidden; display: flex; align-items: center; }
        .running-text-icon { font-size: 24px; margin-right: 20px; flex-shrink: 0; }
        .running-text-wrapper { overflow: hidden; flex: 1; }
        .running-text { display: inline-block; white-space: nowrap; animation: marquee var(--marquee-speed, 30s) linear infinite; }
        .running-text span { color: white; font-weight: 500; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .running-text-container:hover .running-text { animation-play-state: paused; }

        /* Font Classes */
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-raleway { font-family: 'Raleway', sans-serif; }
        .font-quicksand { font-family: 'Quicksand', sans-serif; }
        .font-nunito { font-family: 'Nunito', sans-serif; }
        .font-lobster { font-family: 'Lobster', cursive; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .font-dancing { font-family: 'Dancing Script', cursive; }
        .font-satisfy { font-family: 'Satisfy', cursive; }

        /* Page Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .page-header h1 { font-size: 28px; color: var(--dark); font-weight: 700; display: flex; align-items: center; gap: 15px; }
        .page-header h1 i { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .user-info { display: flex; align-items: center; gap: 15px; background: white; padding: 12px 20px; border-radius: 50px; box-shadow: var(--shadow); }
        .user-avatar { width: 45px; height: 45px; background: var(--gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; }
        .user-avatar.member { background: var(--gradient-2); }
        .user-details h4 { font-size: 14px; color: var(--dark); }
        .user-details p { font-size: 12px; color: #64748b; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 22px; border-radius: 20px; box-shadow: var(--shadow); position: relative; overflow: hidden; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 12px; }
        .stat-card.kas .icon { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .stat-card.member .icon { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .stat-card.paid .icon { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-card.unpaid .icon { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .stat-card h3 { font-size: 24px; color: var(--dark); font-weight: 700; margin-bottom: 5px; }
        .stat-card p { color: #64748b; font-size: 13px; }

        /* Cards */
        .card { background: white; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 25px; overflow: hidden; }
        .card-header { padding: 18px 22px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%); }
        .card-header h2 { font-size: 16px; color: var(--dark); font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-header h2 i { color: var(--primary); }
        .card-body { padding: 22px; }

        /* Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); font-weight: 600; color: var(--dark); font-size: 12px; text-transform: uppercase; }
        tr:hover { background: #f8fafc; }

        /* Badges */
        .badge { padding: 5px 12px; border-radius: 50px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-asn { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .badge-non-asn { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge-lunas { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .badge-belum { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .badge-admin { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .badge-member { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .badge-other { background: rgba(59, 130, 246, 0.1); color: var(--info); }

        /* ========== SLIDESHOW PANEL ========== */
        .payment-layout { display: grid; grid-template-columns: 1fr 320px; gap: 25px; }
        .payment-layout.no-slideshow { grid-template-columns: 1fr; }
        
        .slideshow-panel { position: sticky; top: 20px; height: fit-content; }
        
        .slideshow-container {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .slideshow-header {
            background: var(--gradient);
            color: white;
            padding: 18px 20px;
            text-align: center;
        }
        
        .slideshow-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .slideshow-body {
            padding: 0;
            position: relative;
            min-height: 300px;
        }
        
        .slide {
            display: none;
            padding: 20px;
            animation: fadeSlide 0.5s ease;
        }
        
        .slide.active {
            display: block;
        }
        
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .slide-saldo {
            text-align: center;
            padding: 30px 20px;
        }
        
        .slide-saldo .saldo-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 35px;
            color: white;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }
        
        .slide-saldo .saldo-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .slide-saldo .saldo-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--secondary);
        }
        
        .slide-saldo .saldo-detail {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .slide-saldo .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
        }
        
        .slide-saldo .detail-row .label { color: #64748b; }
        .slide-saldo .detail-row .value { font-weight: 600; color: var(--dark); }
        .slide-saldo .detail-row .value.income { color: var(--secondary); }
        .slide-saldo .detail-row .value.expense { color: var(--danger); }
        
        .slide-allocation {
            padding: 20px;
        }
        
        .slide-allocation .allocation-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 14px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
        }
        
        .slide-allocation .allocation-item:last-child {
            margin-bottom: 0;
        }
        
        .slide-allocation .allocation-date {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 5px;
        }
        
        .slide-allocation .allocation-desc {
            font-size: 14px;
            color: var(--dark);
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .slide-allocation .allocation-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--danger);
        }
        
        .slideshow-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 15px;
            background: #f8fafc;
        }
        
        .slideshow-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .slideshow-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }
        
        .slideshow-nav {
            display: flex;
            justify-content: space-between;
            padding: 0 15px 15px;
        }
        
        .slideshow-nav button {
            width: 35px;
            height: 35px;
            border: none;
            background: #f1f5f9;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slideshow-nav button:hover {
            background: var(--primary);
            color: white;
        }
        
        .slideshow-status {
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
            padding-bottom: 15px;
        }

        /* Profile */
        .profile-card { background: white; border-radius: 24px; overflow: hidden; box-shadow: var(--shadow); }
        .profile-header { background: var(--gradient); padding: 40px; text-align: center; color: white; }
        .profile-avatar { width: 100px; height: 100px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 40px; font-weight: 700; border: 4px solid rgba(255,255,255,0.3); }
        .profile-header h2 { font-size: 24px; margin-bottom: 5px; }
        .profile-header p { opacity: 0.9; }
        .profile-body { padding: 30px; }
        .profile-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .profile-info-item { padding: 20px; background: #f8fafc; border-radius: 14px; }
        .profile-info-item label { font-size: 12px; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 8px; }
        .profile-info-item span { font-size: 16px; font-weight: 600; color: var(--dark); }

        /* Payment Summary */
        .payment-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .summary-card { text-align: center; padding: 20px 15px; border-radius: 14px; background: #f8fafc; }
        .summary-card.total { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
        .summary-card.paid { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
        .summary-card.remaining { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
        .summary-card h4 { font-size: 11px; color: #64748b; text-transform: uppercase; margin-bottom: 8px; }
        .summary-card .value { font-size: 18px; font-weight: 700; color: var(--dark); }
        .summary-card.paid .value { color: var(--secondary); }
        .summary-card.remaining .value { color: var(--danger); }

        /* Month Grid */
        .months-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
        .month-btn { padding: 12px 8px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative; }
        .month-btn:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.2); }
        .month-btn.paid { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-color: var(--secondary); }
        .month-btn.paid::after { content: 'âœ“'; position: absolute; top: 4px; right: 6px; font-size: 10px; color: var(--secondary); font-weight: bold; }
        .month-btn .month-name { font-size: 12px; font-weight: 600; color: var(--dark); display: block; }
        .month-btn .month-amount { font-size: 10px; color: #64748b; margin-top: 2px; display: block; }
        .month-btn.paid .month-name, .month-btn.paid .month-amount { color: #065f46; }
        .month-btn.member-view { cursor: default; }
        .month-btn.member-view:hover { transform: none; box-shadow: none; }
        .month-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Payment History */
        .payment-history { margin-top: 20px; }
        .payment-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 10px; margin-bottom: 8px; }
        .payment-item:hover { background: #f1f5f9; }
        .payment-item-info { flex: 1; }
        .payment-item-info h4 { font-size: 13px; color: var(--dark); margin-bottom: 2px; }
        .payment-item-info p { font-size: 11px; color: #64748b; }
        .payment-item-amount { font-size: 14px; font-weight: 700; color: var(--secondary); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 24px; width: 100%; max-width: 550px; max-height: 90vh; overflow-y: auto; animation: modalPop 0.4s ease; }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { padding: 22px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 24px 24px 0 0; }
        .modal-header h2 { font-size: 18px; color: var(--dark); font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .modal-header h2 i { color: var(--primary); }
        .modal-close { width: 36px; height: 36px; border: none; background: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .modal-close:hover { background: var(--danger); color: white; transform: rotate(90deg); }
        .modal-body { padding: 25px; }
        .modal-footer { padding: 18px 25px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end; background: #fafbfc; border-radius: 0 0 24px 24px; }

        /* Form */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 18px; }
        select.form-control { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 18px center; padding-right: 45px; }
        textarea.form-control { resize: vertical; min-height: 70px; }

        /* Toggle */
        .toggle-container { display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 12px; margin-bottom: 12px; }
        .toggle { position: relative; width: 50px; height: 26px; flex-shrink: 0; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #cbd5e1; border-radius: 26px; transition: 0.4s; }
        .toggle-slider::before { content: ''; position: absolute; width: 20px; height: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .toggle input:checked + .toggle-slider { background: var(--gradient-2); }
        .toggle input:checked + .toggle-slider::before { transform: translateX(24px); }

        /* Search Filter */
        .search-filter { display: flex; gap: 12px; flex-wrap: wrap; }
        .search-filter input, .search-filter select { padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 13px; transition: all 0.3s ease; background: white; }
        .search-filter input:focus, .search-filter select:focus { outline: none; border-color: var(--primary); }

        /* Year Tabs */
        .year-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .year-tab { padding: 10px 22px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; font-weight: 600; transition: all 0.3s ease; font-size: 14px; }
        .year-tab:hover { border-color: var(--primary); }
        .year-tab.active { background: var(--gradient); color: white; border-color: transparent; }
        .year-tab.disabled { opacity: 0.5; cursor: not-allowed; background: #f1f5f9; }

        /* Payment Tabs */
        .payment-tabs { display: flex; gap: 8px; margin-bottom: 18px; flex-wrap: wrap; }
        .payment-tab { padding: 10px 18px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; font-weight: 500; transition: all 0.3s ease; font-size: 13px; }
        .payment-tab:hover { border-color: var(--primary); }
        .payment-tab.active { background: var(--gradient); color: white; border-color: transparent; }
        .payment-tab i { margin-right: 6px; }
        .payment-input-section { display: none; padding: 18px; background: #f8fafc; border-radius: 14px; }
        .payment-input-section.active { display: block; }

        /* Mobile */
        .menu-toggle { display: none; position: fixed; top: 20px; left: 20px; z-index: 1001; width: 50px; height: 50px; background: var(--gradient); border: none; border-radius: 14px; color: white; font-size: 22px; cursor: pointer; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }

        /* Toast */
        .toast-container { position: fixed; top: 25px; right: 25px; z-index: 3000; }
        .toast { background: white; padding: 16px 22px; border-radius: 14px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: toastIn 0.4s ease; min-width: 280px; }
        @keyframes toastIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 4px solid var(--secondary); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.info { border-left: 4px solid var(--info); }
        .toast i { font-size: 22px; }
        .toast.success i { color: var(--secondary); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        .toast.info i { color: var(--info); }

        /* Admin List */
        .admin-list { display: grid; gap: 12px; }
        .admin-item { display: flex; justify-content: space-between; align-items: center; padding: 18px; background: #f8fafc; border-radius: 14px; transition: all 0.3s ease; }
        .admin-item:hover { background: white; box-shadow: var(--shadow); }
        .admin-info { display: flex; align-items: center; gap: 12px; }
        .admin-avatar { width: 50px; height: 50px; background: var(--gradient); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 20px; }

        /* Empty State */
        .empty-state { text-align: center; padding: 50px 25px; color: #64748b; }
        .empty-state i { font-size: 60px; margin-bottom: 18px; color: #cbd5e1; }
        .empty-state h3 { font-size: 18px; color: var(--dark); margin-bottom: 8px; }

        /* Sections */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Confirm Modal */
        .confirm-content { text-align: center; padding: 25px; }
        .confirm-icon { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 18px; font-size: 35px; }
        .confirm-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .confirm-icon.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .confirm-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .confirm-content h3 { font-size: 20px; color: var(--dark); margin-bottom: 8px; }
        .confirm-content p { color: #64748b; line-height: 1.5; font-size: 14px; }

        /* Member Payment Card */
        .member-payment-card { background: white; border-radius: 18px; padding: 20px; margin-bottom: 18px; box-shadow: var(--shadow); }
        .member-payment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; flex-wrap: wrap; gap: 12px; }
        .member-info-row { display: flex; align-items: center; gap: 12px; }
        .member-avatar-sm { width: 45px; height: 45px; background: var(--gradient); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px; }
        .member-stats { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .member-stat { text-align: center; padding: 8px 14px; background: #f8fafc; border-radius: 8px; }
        .member-stat .value { font-size: 14px; font-weight: 700; }
        .member-stat .label { font-size: 10px; color: #64748b; text-transform: uppercase; }

        /* Settings Grid */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; }
        .font-preview { padding: 12px; background: #f8fafc; border-radius: 8px; margin-top: 8px; }
        .font-preview-text { font-size: 16px; color: var(--dark); }
        .speed-slider { width: 100%; margin: 8px 0; }
        .speed-value { font-weight: 600; color: var(--primary); }

        /* Responsive */
        @media (max-width: 1200px) {
            .payment-layout { grid-template-columns: 1fr; }
            .slideshow-panel { position: relative; top: 0; order: -1; }
        }
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-left: 0; padding: 70px 15px 25px; }
            .menu-toggle { display: flex; align-items: center; justify-content: center; }
        }
        @media (max-width: 576px) {
            .login-box { padding: 30px 22px; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .page-header h1 { font-size: 20px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .months-grid { grid-template-columns: repeat(4, 1fr); gap: 6px; }
            .month-btn { padding: 10px 6px; }
            .month-btn .month-name { font-size: 11px; }
            .month-btn .month-amount { font-size: 8px; }
            th, td { padding: 8px 6px; font-size: 11px; }
            .payment-tabs { flex-direction: column; }
            .payment-tab { width: 100%; justify-content: center; }
        }
        @media print {
            .sidebar, .menu-toggle, .btn, .modal, .toast-container, .running-text-container, .slideshow-panel { display: none !important; }
            .main-content { margin-left: 0 !important; padding: 20px !important; }
            .payment-layout { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text">Memuat aplikasi...</p>
    </div>
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Page -->
    <div class="login-container" id="loginPage" style="display: none;">
        <div class="login-box">
            <div class="login-logo">
                <div class="icon-wrapper"><i class="fas fa-mosque"></i></div>
                <h1>KKG PAI</h1>
                <p>Kecamatan Nagreg</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> User ID (No HP)</label>
                    <div class="input-group"><i class="fas fa-mobile-alt"></i><input type="text" class="form-control" id="loginPhone" placeholder="Masukkan User ID" required></div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password (NRG)</label>
                    <div class="input-group"><i class="fas fa-key"></i><input type="password" class="form-control" id="loginPassword" placeholder="Masukkan Password" required></div>
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Masuk</button>
            </form>
            <div class="login-hint">
                <p><i class="fas fa-info-circle"></i> <strong>Cara Login:</strong></p>
                <div class="hint-item"><i class="fas fa-user-shield"></i><span><strong>Admin:</strong> User ID & Password admin</span></div>
                <div class="hint-item"><i class="fas fa-user"></i><span><strong>Anggota:</strong> No HP & NRG</span></div>
                <p style="margin-top: 10px; font-size: 11px;">Default: <code>admin</code> / <code>admin123</code></p>
            </div>
        </div>
    </div>  
  <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon"><i class="fas fa-mosque"></i></div>
                <h2>KKG PAI Nagreg</h2>
                <p>Sistem Iuran Digital</p>
            </div>
            <ul class="nav-menu">
                <li class="member-menu"><a href="#" class="nav-link" data-section="profile-section"><i class="fas fa-user"></i> Profil Saya</a></li>
                <li class="member-menu"><a href="#" class="nav-link" data-section="my-payment-section"><i class="fas fa-money-bill-wave"></i> Pembayaran Saya</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="dashboard-section"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="members-section"><i class="fas fa-users"></i> Data Anggota</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="payments-section"><i class="fas fa-money-bill-wave"></i> Pembayaran</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="allocations-section"><i class="fas fa-chart-pie"></i> Alokasi Dana</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="reports-section"><i class="fas fa-file-invoice-dollar"></i> Laporan</a></li>
                <div class="nav-divider admin-only"></div>
                <li class="admin-only"><a href="#" class="nav-link" data-section="admins-section"><i class="fas fa-user-shield"></i> Kelola Admin</a></li>
                <li class="admin-only"><a href="#" class="nav-link" data-section="settings-section"><i class="fas fa-cogs"></i> Pengaturan</a></li>
                <div class="nav-divider"></div>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Keluar</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="running-text-container" id="runningTextContainer">
                <span class="running-text-icon">ðŸ“¢</span>
                <div class="running-text-wrapper">
                    <div class="running-text" id="runningTextElement"><span id="runningTextContent">Selamat datang di Sistem Iuran KKG PAI Kecamatan Nagreg ðŸŽ‰</span></div>
                </div>
            </div>

            <!-- MEMBER: Profile -->
            <section class="section" id="profile-section">
                <div class="page-header"><h1><i class="fas fa-user"></i> Profil Saya</h1></div>
                <div class="profile-card"><div class="profile-header"><div class="profile-avatar" id="profileAvatarLarge">A</div><h2 id="profileNameLarge">-</h2><p id="profileStatus">-</p></div><div class="profile-body"><div class="profile-info"><div class="profile-info-item"><label><i class="fas fa-phone"></i> No HP</label><span id="profilePhone">-</span></div><div class="profile-info-item"><label><i class="fas fa-id-card"></i> NRG</label><span id="profileNRG">-</span></div><div class="profile-info-item"><label><i class="fas fa-building"></i> Status</label><span id="profileStatusBadge">-</span></div><div class="profile-info-item"><label><i class="fas fa-school"></i> Sekolah</label><span id="profileSchool">-</span></div></div></div></div>
            </section>

            <!-- MEMBER: My Payment -->
            <section class="section" id="my-payment-section">
                <div class="page-header"><h1><i class="fas fa-money-bill-wave"></i> Pembayaran Saya</h1></div>
                <div class="year-tabs" id="memberYearTabs"></div>
                <div class="card"><div class="card-header"><h2><i class="fas fa-calendar-check"></i> Status Iuran <span id="memberYearLabel">2024</span></h2></div><div class="card-body"><div class="payment-summary" id="memberPaymentSummary"></div><h4 style="margin-bottom: 12px; color: var(--dark); font-size: 14px;"><i class="fas fa-calendar"></i> Detail Per Bulan</h4><div class="months-grid" id="memberMonthsGrid"></div><div class="payment-history" id="memberPaymentHistory"></div></div></div>
            </section>

            <!-- ADMIN: Dashboard -->
            <section class="section" id="dashboard-section">
                <div class="page-header"><h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1><div class="user-info"><div class="user-details"><h4 id="welcomeUser">Administrator</h4><p><span class="badge badge-admin"><i class="fas fa-shield-alt"></i> Admin</span></p></div><div class="user-avatar" id="userAvatar">A</div></div></div>
                <div class="stats-grid"><div class="stat-card kas"><div class="icon"><i class="fas fa-wallet"></i></div><h3 id="totalKas">Rp 0</h3><p>Saldo KAS KKG</p></div><div class="stat-card member"><div class="icon"><i class="fas fa-users"></i></div><h3 id="totalMember">0</h3><p>Total Anggota</p></div><div class="stat-card paid"><div class="icon"><i class="fas fa-check-double"></i></div><h3 id="totalLunas">0</h3><p>Sudah Lunas</p></div><div class="stat-card unpaid"><div class="icon"><i class="fas fa-clock"></i></div><h3 id="totalBelumLunas">0</h3><p>Belum Lunas</p></div></div>
                <div class="card"><div class="card-header"><h2><i class="fas fa-history"></i> Aktivitas Terakhir</h2></div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Waktu</th><th>Nama</th><th>Keterangan</th><th>Nominal</th></tr></thead><tbody id="recentActivities"></tbody></table></div></div></div>
            </section>

            <!-- ADMIN: Members -->
            <section class="section" id="members-section">
                <div class="page-header"><h1><i class="fas fa-users"></i> Data Anggota</h1><button class="btn btn-primary btn-sm" onclick="openModal('addMemberModal')"><i class="fas fa-user-plus"></i> Tambah</button></div>
                <div class="card"><div class="card-header"><h2><i class="fas fa-list"></i> Daftar Anggota</h2><div class="search-filter"><input type="text" id="searchMember" placeholder="ðŸ” Cari..." oninput="renderMembers()"><select id="filterStatus" onchange="renderMembers()"><option value="">Semua</option><option value="ASN">ASN</option><option value="Non ASN">Non ASN</option></select></div></div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>No</th><th>Nama</th><th>HP</th><th>NRG</th><th>Status</th><th>Sekolah</th><th>Progress</th><th>Aksi</th></tr></thead><tbody id="membersList"></tbody></table></div></div></div>
            </section>

            <!-- ADMIN: Payments with Slideshow -->
            <section class="section" id="payments-section">
                <div class="page-header"><h1><i class="fas fa-money-bill-wave"></i> Pembayaran</h1></div>
                <div class="year-tabs" id="yearTabs"></div>
                <div class="card" style="margin-bottom: 18px;"><div class="card-body" style="padding: 15px;"><div class="search-filter"><input type="text" id="searchPayment" placeholder="ðŸ” Cari nama..." style="flex: 1;" oninput="renderPaymentCards()"><select id="filterPaymentStatus" onchange="renderPaymentCards()"><option value="">Semua</option><option value="lunas">Lunas</option><option value="belum">Belum</option></select></div></div></div>
                
                <!-- Payment Layout with Slideshow -->
                <div class="payment-layout" id="paymentLayout">
                    <div class="payment-cards-wrapper">
                        <div id="paymentCardsContainer"></div>
                    </div>
                    
                    <!-- Slideshow Panel -->
                    <div class="slideshow-panel" id="slideshowPanel">
                        <div class="slideshow-container">
                            <div class="slideshow-header">
                                <h3><i class="fas fa-chart-pie"></i> Info Keuangan</h3>
                            </div>
                            <div class="slideshow-body" id="slideshowBody">
                                <!-- Slides will be rendered here -->
                            </div>
                            <div class="slideshow-dots" id="slideshowDots"></div>
                            <div class="slideshow-nav">
                                <button onclick="prevSlide()"><i class="fas fa-chevron-left"></i></button>
                                <button onclick="nextSlide()"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="slideshow-status" id="slideshowStatus">Auto-slide: Aktif</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ADMIN: Allocations -->
            <section class="section" id="allocations-section">
                <div class="page-header"><h1><i class="fas fa-chart-pie"></i> Alokasi Dana</h1><button class="btn btn-primary btn-sm" onclick="openModal('addAllocationModal')"><i class="fas fa-plus-circle"></i> Tambah</button></div>
                <div class="stats-grid"><div class="stat-card kas"><div class="icon"><i class="fas fa-arrow-down"></i></div><h3 id="totalIncome">Rp 0</h3><p>Total Pemasukan</p></div><div class="stat-card unpaid"><div class="icon"><i class="fas fa-arrow-up"></i></div><h3 id="totalExpense">Rp 0</h3><p>Total Pengeluaran</p></div><div class="stat-card member"><div class="icon"><i class="fas fa-piggy-bank"></i></div><h3 id="remainingKas">Rp 0</h3><p>Sisa KAS</p></div></div>
                <div class="card"><div class="card-header"><h2><i class="fas fa-receipt"></i> Riwayat Pengeluaran</h2></div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>No</th><th>Tanggal</th><th>Keterangan</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody id="allocationsList"></tbody></table></div></div></div>
            </section>

            <!-- ADMIN: Reports -->
            <section class="section" id="reports-section">
                <div class="page-header"><h1><i class="fas fa-file-invoice-dollar"></i> Laporan</h1><button class="btn btn-primary btn-sm" onclick="window.print()"><i class="fas fa-print"></i> Cetak</button></div>
                <div id="reportContent"></div>
            </section>

            <!-- ADMIN: Admins -->
            <section class="section" id="admins-section">
                <div class="page-header"><h1><i class="fas fa-user-shield"></i> Kelola Admin</h1><button class="btn btn-primary btn-sm" onclick="openModal('addAdminModal')"><i class="fas fa-user-plus"></i> Tambah</button></div>
                <div class="card"><div class="card-header"><h2><i class="fas fa-users-cog"></i> Daftar Admin</h2></div><div class="card-body"><div class="admin-list" id="adminsList"></div></div></div>
            </section>

            <!-- ADMIN: Settings -->
            <section class="section" id="settings-section">
                <div class="page-header"><h1><i class="fas fa-cogs"></i> Pengaturan</h1></div>
                <div class="settings-grid">
                    <!-- Running Text Settings -->
                    <div class="card"><div class="card-header"><h2><i class="fas fa-bullhorn"></i> Running Text</h2></div><div class="card-body">
                        <div class="form-group"><label>Isi Teks</label><textarea class="form-control no-icon" id="settingRunningText" rows="2"></textarea></div>
                        <div class="form-group"><label>Font</label><select class="form-control no-icon" id="settingFont" onchange="previewFont()"><option value="font-poppins">Poppins</option><option value="font-montserrat">Montserrat</option><option value="font-raleway">Raleway</option><option value="font-quicksand">Quicksand</option><option value="font-nunito">Nunito</option><option value="font-playfair">Playfair</option><option value="font-lobster">Lobster</option><option value="font-pacifico">Pacifico</option><option value="font-dancing">Dancing Script</option><option value="font-satisfy">Satisfy</option></select><div class="font-preview"><span class="font-preview-text" id="fontPreview">Preview Font</span></div></div>
                        <div class="form-group"><label>Kecepatan: <span class="speed-value" id="speedValue">30</span>s</label><input type="range" class="speed-slider" id="settingSpeed" min="10" max="60" value="30" oninput="updateSpeedValue()"></div>
                        <div class="toggle-container"><label class="toggle"><input type="checkbox" id="settingShowUnpaid" checked><span class="toggle-slider"></span></label><div><strong>Tampilkan Belum Lunas</strong></div></div>
                    </div></div>
                    
                    <!-- Slideshow Settings -->
                    <div class="card"><div class="card-header"><h2><i class="fas fa-images"></i> Slideshow Alokasi</h2></div><div class="card-body">
                        <div class="toggle-container"><label class="toggle"><input type="checkbox" id="settingSlideshow" checked><span class="toggle-slider"></span></label><div><strong>Aktifkan Slideshow</strong><p style="font-size:12px;color:#64748b;">Panel info keuangan di halaman pembayaran</p></div></div>
                        <div class="form-group"><label>Kecepatan Slide: <span class="speed-value" id="slideSpeedValue">5</span>s</label><input type="range" class="speed-slider" id="settingSlideSpeed" min="3" max="15" value="5" oninput="updateSlideSpeedValue()"></div>
                        <div class="toggle-container"><label class="toggle"><input type="checkbox" id="settingAutoSlide" checked><span class="toggle-slider"></span></label><div><strong>Auto Slide</strong><p style="font-size:12px;color:#64748b;">Slide bergerak otomatis</p></div></div>
                    </div></div>
                    
                    <!-- Iuran Settings -->
                    <div class="card"><div class="card-header"><h2><i class="fas fa-money-bill"></i> Iuran</h2></div><div class="card-body">
                        <div class="form-group"><label>Iuran ASN/bulan</label><input type="number" class="form-control no-icon" id="settingIuranASN" value="50000"></div>
                        <div class="form-group"><label>Iuran Non ASN/bulan</label><input type="number" class="form-control no-icon" id="settingIuranNonASN" value="25000"></div>
                        <div class="form-group"><label>Tahun Aktif</label><input type="number" class="form-control no-icon" id="settingActiveYear" value="2024"></div>
                    </div></div>
                    
                    <!-- Year Visibility -->
                    <div class="card"><div class="card-header"><h2><i class="fas fa-eye"></i> Visibilitas Tahun</h2></div><div class="card-body" id="yearVisibilitySettings"></div></div>
                </div>
                <button class="btn btn-success" onclick="saveSettings()" style="margin-top: 18px;"><i class="fas fa-save"></i> Simpan Pengaturan</button>
            </section>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal" id="addMemberModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-user-plus"></i> Tambah Anggota</h2><button class="modal-close" onclick="closeModal('addMemberModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="form-group"><label>Nama *</label><input type="text" class="form-control no-icon" id="memberName" required></div><div class="form-row"><div class="form-group"><label>No HP *</label><input type="text" class="form-control no-icon" id="memberPhone" required></div><div class="form-group"><label>NRG *</label><input type="text" class="form-control no-icon" id="memberNRG" required></div></div><div class="form-row"><div class="form-group"><label>Status *</label><select class="form-control no-icon" id="memberStatus" required><option value="">Pilih</option><option value="ASN">ASN</option><option value="Non ASN">Non ASN</option></select></div><div class="form-group"><label>Sekolah *</label><input type="text" class="form-control no-icon" id="memberSchool" required></div></div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" onclick="closeModal('addMemberModal')">Batal</button><button class="btn btn-success btn-sm" onclick="saveMember()"><i class="fas fa-save"></i> Simpan</button></div></div></div>

    <div class="modal" id="editMemberModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-user-edit"></i> Edit Anggota</h2><button class="modal-close" onclick="closeModal('editMemberModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><input type="hidden" id="editMemberId"><div class="form-group"><label>Nama *</label><input type="text" class="form-control no-icon" id="editMemberName" required></div><div class="form-row"><div class="form-group"><label>No HP *</label><input type="text" class="form-control no-icon" id="editMemberPhone" required></div><div class="form-group"><label>NRG *</label><input type="text" class="form-control no-icon" id="editMemberNRG" required></div></div><div class="form-row"><div class="form-group"><label>Status *</label><select class="form-control no-icon" id="editMemberStatus" required><option value="ASN">ASN</option><option value="Non ASN">Non ASN</option></select></div><div class="form-group"><label>Sekolah *</label><input type="text" class="form-control no-icon" id="editMemberSchool" required></div></div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" onclick="closeModal('editMemberModal')">Batal</button><button class="btn btn-success btn-sm" onclick="updateMember()"><i class="fas fa-save"></i> Update</button></div></div></div>

    <div class="modal" id="addAdminModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-user-shield"></i> Tambah Admin</h2><button class="modal-close" onclick="closeModal('addAdminModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="form-group"><label>Nama *</label><input type="text" class="form-control no-icon" id="adminName" required></div><div class="form-group"><label>User ID *</label><input type="text" class="form-control no-icon" id="adminPhone" required></div><div class="form-group"><label>Password *</label><input type="text" class="form-control no-icon" id="adminPassword" required></div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" onclick="closeModal('addAdminModal')">Batal</button><button class="btn btn-success btn-sm" onclick="saveAdmin()"><i class="fas fa-save"></i> Simpan</button></div></div></div>

    <div class="modal" id="addAllocationModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-plus-circle"></i> Tambah Pengeluaran</h2><button class="modal-close" onclick="closeModal('addAllocationModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><div class="form-group"><label>Tanggal *</label><input type="date" class="form-control no-icon" id="allocationDate" required></div><div class="form-group"><label>Keterangan *</label><input type="text" class="form-control no-icon" id="allocationDesc" required></div><div class="form-group"><label>Nominal *</label><input type="number" class="form-control no-icon" id="allocationAmount" required></div></div><div class="modal-footer"><button class="btn btn-secondary btn-sm" onclick="closeModal('addAllocationModal')">Batal</button><button class="btn btn-success btn-sm" onclick="saveAllocation()"><i class="fas fa-save"></i> Simpan</button></div></div></div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal"><div class="modal-content" style="max-width: 580px;"><div class="modal-header"><h2><i class="fas fa-money-bill-wave"></i> Input Pembayaran</h2><button class="modal-close" onclick="closeModal('paymentModal')"><i class="fas fa-times"></i></button></div><div class="modal-body">
        <div id="paymentMemberInfo" style="margin-bottom: 18px; padding: 14px; background: #f8fafc; border-radius: 12px;"></div>
        <div class="payment-tabs">
            <div class="payment-tab active" onclick="switchPaymentTab('month')"><i class="fas fa-calendar"></i> Klik Bulan</div>
            <div class="payment-tab" onclick="switchPaymentTab('nominal')"><i class="fas fa-keyboard"></i> Input Nominal</div>
            <div class="payment-tab" onclick="switchPaymentTab('other')"><i class="fas fa-plus-circle"></i> Lainnya</div>
        </div>
        <div class="payment-input-section active" id="paymentTabMonth"><p style="margin-bottom: 12px; color: #64748b; font-size: 13px;"><i class="fas fa-info-circle"></i> Klik bulan untuk bayar</p><div class="months-grid" id="paymentMonthsGrid"></div></div>
        <div class="payment-input-section" id="paymentTabNominal">
            <div class="form-group"><label>Bulan *</label><select class="form-control no-icon" id="paymentMonth"></select></div>
            <div class="form-group"><label>Nominal *</label><input type="number" class="form-control no-icon" id="paymentNominal"></div>
            <div class="form-group"><label>Keterangan</label><textarea class="form-control no-icon" id="paymentNote" rows="2"></textarea></div>
            <button class="btn btn-success" onclick="saveNominalPayment()" style="width: 100%;"><i class="fas fa-save"></i> Simpan</button>
        </div>
        <div class="payment-input-section" id="paymentTabOther">
            <p style="margin-bottom: 12px; color: #64748b; font-size: 13px;"><i class="fas fa-info-circle"></i> Pembayaran di luar iuran bulanan</p>
            <div class="form-group"><label>Nominal *</label><input type="number" class="form-control no-icon" id="otherPaymentAmount"></div>
            <div class="form-group"><label>Keterangan * (wajib)</label><textarea class="form-control no-icon" id="otherPaymentNote" rows="2" placeholder="Sumbangan, Donasi, Infaq, dll"></textarea></div>
            <button class="btn btn-success" onclick="saveOtherPayment()" style="width: 100%;"><i class="fas fa-save"></i> Simpan</button>
        </div>
    </div></div></div>

    <div class="modal" id="confirmModal"><div class="modal-content" style="max-width: 400px;"><div class="confirm-content"><div class="confirm-icon" id="confirmIcon"><i class="fas fa-question"></i></div><h3 id="confirmTitle">Konfirmasi</h3><p id="confirmMessage">Yakin?</p></div><div class="modal-footer" style="justify-content: center;"><button class="btn btn-secondary btn-sm" onclick="closeModal('confirmModal')">Batal</button><button class="btn btn-success btn-sm" id="confirmBtn">Ya</button></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
   
 <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA03kLjLZ_YrT6gBwmX7-f-3YZmLvdNtoc",
            authDomain: "iuran-kkg.firebaseapp.com",
            projectId: "iuran-kkg",
            storageBucket: "iuran-kkg.firebasestorage.app",
            messagingSenderId: "1073355365967",
            appId: "1:1073355365967:web:0d367824dc1c64d35d143a",
            measurementId: "G-93R57Y0PYD"
        };

        let db, firebaseConnected = false;
        let currentUser = null, members = [], payments = [], allocations = [], admins = [];
        let selectedYear = new Date().getFullYear(), memberSelectedYear = new Date().getFullYear();
        let currentPaymentMember = null;
        let currentSlide = 0, slideInterval = null, totalSlides = 0;

        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
        const FULL_MONTHS = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        let settings = {
            runningText: "Selamat datang di Sistem Iuran KKG PAI Kecamatan Nagreg ðŸŽ‰",
            iuranASN: 50000, iuranNonASN: 25000, showUnpaid: true,
            activeYear: new Date().getFullYear(), font: 'font-poppins', speed: 30, visibleYears: {},
            slideshowEnabled: true, slideSpeed: 5, autoSlide: true
        };

        document.addEventListener('DOMContentLoaded', initApp);

        async function initApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                await testConnection();
                if (firebaseConnected) { await loadAdmins(); await loadMembers(); if (admins.length === 0) await createDefaultAdmin(); await loadSettings(); }
                setupEventListeners(); initYearTabs(); initMemberYearTabs(); renderYearVisibilitySettings();
            } catch (e) { console.error(e); showToast('Koneksi gagal!', 'error'); }
            finally { hideLoading(); document.getElementById('loginPage').style.display = 'flex'; }
        }

        async function testConnection() { try { await db.collection('_test').doc('_test').get(); firebaseConnected = true; } catch (e) { firebaseConnected = false; } }
        async function createDefaultAdmin() { await db.collection('admins').doc('default').set({ name: 'Administrator', phone: 'admin', nrg: 'admin123', createdAt: new Date().toISOString() }); await loadAdmins(); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleNavigation));
            document.getElementById('menuToggle').addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebarOverlay').classList.toggle('active'); });
            document.getElementById('sidebarOverlay').addEventListener('click', () => { document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebarOverlay').classList.remove('active'); });
            document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); }));
            document.getElementById('allocationDate').value = new Date().toISOString().split('T')[0];
        }

        async function handleLogin(e) {
            e.preventDefault();
            if (!firebaseConnected) { showToast('Tidak terhubung!', 'error'); return; }
            const phone = document.getElementById('loginPhone').value.trim(), password = document.getElementById('loginPassword').value.trim();
            let user = admins.find(a => a.phone === phone && a.nrg === password);
            if (user) { currentUser = { ...user, role: 'admin' }; await showDashboard(); showToast(`Halo, ${user.name}!`, 'success'); return; }
            user = members.find(m => m.phone === phone && m.nrg === password);
            if (user) { currentUser = { ...user, role: 'member' }; await showDashboard(); showToast(`Halo, ${user.name}!`, 'success'); return; }
            showToast('Login gagal!', 'error');
        }

        function handleLogout(e) { e.preventDefault(); currentUser = null; stopSlideshow(); document.getElementById('dashboard').style.display = 'none'; document.getElementById('loginPage').style.display = 'flex'; document.getElementById('loginForm').reset(); showToast('Logout berhasil', 'info'); }

        async function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            const isAdmin = currentUser.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
            document.querySelectorAll('.member-menu').forEach(el => el.style.display = isAdmin ? 'none' : 'block');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (isAdmin) {
                document.getElementById('dashboard-section').classList.add('active');
                document.querySelector('[data-section="dashboard-section"]')?.classList.add('active');
                document.getElementById('welcomeUser').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
            } else {
                document.getElementById('profile-section').classList.add('active');
                document.querySelector('[data-section="profile-section"]')?.classList.add('active');
                renderMemberProfile();
            }
            await loadAllData();
        }

        function handleNavigation(e) {
            e.preventDefault(); const section = this.dataset.section; if (!section) return;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); this.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(section).classList.add('active');
            document.getElementById('sidebar').classList.remove('active'); document.getElementById('sidebarOverlay').classList.remove('active');
            if (section === 'my-payment-section') renderMemberPayment();
            if (section === 'payments-section') { renderSlideshow(); if (settings.autoSlide) startSlideshow(); }
            else { stopSlideshow(); }
        }

        async function loadAllData() { if (!firebaseConnected) return; await Promise.all([loadMembers(), loadPayments(), loadAllocations()]); if (currentUser?.role === 'admin') { updateDashboard(); generateReport(); renderSlideshow(); } else { renderMemberProfile(); renderMemberPayment(); } updateRunningText(); }
        async function loadAdmins() { if (!firebaseConnected) return; const s = await db.collection('admins').get(); admins = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAdmins(); }
        async function loadMembers() { if (!firebaseConnected) return; const s = await db.collection('members').orderBy('name').get(); members = s.docs.map(d => ({ id: d.id, ...d.data() })); renderMembers(); }
        async function loadPayments() { if (!firebaseConnected) return; const s = await db.collection('payments').orderBy('createdAt', 'desc').get(); payments = s.docs.map(d => ({ id: d.id, ...d.data() })); renderPaymentCards(); renderRecentActivities(); if (currentUser?.role === 'member') renderMemberPayment(); renderSlideshow(); }
        async function loadAllocations() { if (!firebaseConnected) return; const s = await db.collection('allocations').orderBy('date', 'desc').get(); allocations = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAllocations(); renderSlideshow(); }
        async function loadSettings() { if (!firebaseConnected) return; const d = await db.collection('settings').doc('app').get(); if (d.exists) settings = { ...settings, ...d.data() }; applySettings(); }

        function applySettings() {
            document.getElementById('settingRunningText').value = settings.runningText;
            document.getElementById('settingIuranASN').value = settings.iuranASN;
            document.getElementById('settingIuranNonASN').value = settings.iuranNonASN;
            document.getElementById('settingActiveYear').value = settings.activeYear;
            document.getElementById('settingShowUnpaid').checked = settings.showUnpaid;
            document.getElementById('settingFont').value = settings.font || 'font-poppins';
            document.getElementById('settingSpeed').value = settings.speed || 30;
            document.getElementById('speedValue').textContent = settings.speed || 30;
            document.getElementById('settingSlideshow').checked = settings.slideshowEnabled !== false;
            document.getElementById('settingSlideSpeed').value = settings.slideSpeed || 5;
            document.getElementById('slideSpeedValue').textContent = settings.slideSpeed || 5;
            document.getElementById('settingAutoSlide').checked = settings.autoSlide !== false;
            selectedYear = settings.activeYear; memberSelectedYear = settings.activeYear;
            const el = document.getElementById('runningTextElement');
            el.className = `running-text ${settings.font || 'font-poppins'}`;
            el.style.animationDuration = `${settings.speed || 30}s`;
            previewFont(); renderYearVisibilitySettings(); updateSlideshowVisibility();
        }

        function previewFont() { document.getElementById('fontPreview').className = `font-preview-text ${document.getElementById('settingFont').value}`; }
        function updateSpeedValue() { document.getElementById('speedValue').textContent = document.getElementById('settingSpeed').value; }
        function updateSlideSpeedValue() { document.getElementById('slideSpeedValue').textContent = document.getElementById('settingSlideSpeed').value; }

        function updateSlideshowVisibility() {
            const layout = document.getElementById('paymentLayout');
            const panel = document.getElementById('slideshowPanel');
            if (settings.slideshowEnabled) { layout.classList.remove('no-slideshow'); panel.style.display = 'block'; }
            else { layout.classList.add('no-slideshow'); panel.style.display = 'none'; }
        }

        function renderYearVisibilitySettings() {
            const cy = new Date().getFullYear(), years = [];
            for (let y = cy - 3; y <= cy + 1; y++) years.push(y);
            document.getElementById('yearVisibilitySettings').innerHTML = years.map(y => `<div class="toggle-container"><label class="toggle"><input type="checkbox" id="yearVisible${y}" ${settings.visibleYears[y] !== false ? 'checked' : ''}><span class="toggle-slider"></span></label><div><strong>${y}</strong></div></div>`).join('');
        }

        // ========== SLIDESHOW ==========
        function renderSlideshow() {
            if (!settings.slideshowEnabled) return;
            const totalP = payments.reduce((s, p) => s + (p.amount || 0), 0);
            const totalA = allocations.reduce((s, a) => s + (a.amount || 0), 0);
            const saldo = totalP - totalA;
            
            let slidesHTML = '';
            
            // Slide 1: Saldo
            slidesHTML += `<div class="slide active slide-saldo">
                <div class="saldo-icon"><i class="fas fa-wallet"></i></div>
                <div class="saldo-label">Saldo KAS KKG</div>
                <div class="saldo-value">${formatRupiah(saldo)}</div>
                <div class="saldo-detail">
                    <div class="detail-row"><span class="label">Total Pemasukan</span><span class="value income">+${formatRupiah(totalP)}</span></div>
                    <div class="detail-row"><span class="label">Total Pengeluaran</span><span class="value expense">-${formatRupiah(totalA)}</span></div>
                </div>
            </div>`;
            
            // Slide 2-N: Allocations (3 per slide)
            const recentAllocations = allocations.slice(0, 9);
            for (let i = 0; i < recentAllocations.length; i += 3) {
                const chunk = recentAllocations.slice(i, i + 3);
                slidesHTML += `<div class="slide slide-allocation">
                    <h4 style="font-size:14px;color:var(--dark);margin-bottom:12px;"><i class="fas fa-receipt"></i> Rincian Pengeluaran</h4>
                    ${chunk.map(a => `<div class="allocation-item">
                        <div class="allocation-date"><i class="fas fa-calendar"></i> ${formatDate(a.date)}</div>
                        <div class="allocation-desc">${a.description}</div>
                        <div class="allocation-amount">-${formatRupiah(a.amount)}</div>
                    </div>`).join('')}
                </div>`;
            }
            
            document.getElementById('slideshowBody').innerHTML = slidesHTML;
            
            const slides = document.querySelectorAll('#slideshowBody .slide');
            totalSlides = slides.length;
            
            // Render dots
            let dotsHTML = '';
            for (let i = 0; i < totalSlides; i++) {
                dotsHTML += `<div class="slideshow-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></div>`;
            }
            document.getElementById('slideshowDots').innerHTML = dotsHTML;
            
            currentSlide = 0;
            showSlide(0);
            document.getElementById('slideshowStatus').textContent = settings.autoSlide ? `Auto-slide: ${settings.slideSpeed}s` : 'Manual';
        }

        function showSlide(index) {
            const slides = document.querySelectorAll('#slideshowBody .slide');
            const dots = document.querySelectorAll('.slideshow-dot');
            slides.forEach((s, i) => { s.classList.toggle('active', i === index); });
            dots.forEach((d, i) => { d.classList.toggle('active', i === index); });
            currentSlide = index;
        }

        function nextSlide() { showSlide((currentSlide + 1) % totalSlides); }
        function prevSlide() { showSlide((currentSlide - 1 + totalSlides) % totalSlides); }
        function goToSlide(index) { showSlide(index); }

        function startSlideshow() {
            if (!settings.slideshowEnabled || !settings.autoSlide) return;
            stopSlideshow();
            slideInterval = setInterval(() => { nextSlide(); }, (settings.slideSpeed || 5) * 1000);
        }

        function stopSlideshow() { if (slideInterval) { clearInterval(slideInterval); slideInterval = null; } }

        // ========== YEAR TABS ==========
        function initYearTabs() { const cy = new Date().getFullYear(); document.getElementById('yearTabs').innerHTML = [cy-1,cy,cy+1].map(y => `<button class="year-tab ${y===selectedYear?'active':''}" onclick="selectYear(${y})">${y}</button>`).join(''); }
        function initMemberYearTabs() { const cy = new Date().getFullYear(); document.getElementById('memberYearTabs').innerHTML = [cy-1,cy,cy+1].map(y => { const vis = settings.visibleYears[y] !== false; return `<button class="year-tab ${y===memberSelectedYear?'active':''} ${!vis?'disabled':''}" onclick="${vis?`selectMemberYear(${y})`:''}">${y}</button>`; }).join(''); }
        function selectYear(y) { selectedYear = y; document.querySelectorAll('#yearTabs .year-tab').forEach(t => t.classList.toggle('active', parseInt(t.textContent)===y)); renderPaymentCards(); renderSlideshow(); }
        function selectMemberYear(y) { if (settings.visibleYears[y] === false) return; memberSelectedYear = y; document.getElementById('memberYearLabel').textContent = y; document.querySelectorAll('#memberYearTabs .year-tab').forEach(t => t.classList.toggle('active', parseInt(t.textContent)===y)); renderMemberPayment(); }

        // ========== RENDERS ==========
        function getMemberPaymentStats(mid) {
            const mps = payments.filter(p => p.memberId === mid && p.year == selectedYear && !p.isOther);
            const paid = mps.reduce((s, p) => s + (p.amount || 0), 0);
            const paidMonths = mps.filter(p => p.monthKey).map(p => p.monthKey);
            const mem = members.find(m => m.id === mid);
            const ipm = mem?.status === 'ASN' ? settings.iuranASN : settings.iuranNonASN;
            return { paid, total: ipm * 12, paidMonths };
        }

        function renderMemberProfile() {
            if (!currentUser || currentUser.role !== 'member') return;
            const m = currentUser;
            document.getElementById('profileAvatarLarge').textContent = m.name.charAt(0).toUpperCase();
            document.getElementById('profileNameLarge').textContent = m.name;
            document.getElementById('profileStatus').textContent = m.status;
            document.getElementById('profilePhone').textContent = m.phone;
            document.getElementById('profileNRG').textContent = m.nrg;
            document.getElementById('profileStatusBadge').innerHTML = `<span class="badge badge-${m.status==='ASN'?'asn':'non-asn'}">${m.status}</span>`;
            document.getElementById('profileSchool').textContent = m.school;
        }

        function renderMemberPayment() {
            if (!currentUser || currentUser.role !== 'member') return;
            initMemberYearTabs();
            const m = currentUser, ipm = m.status === 'ASN' ? settings.iuranASN : settings.iuranNonASN;
            const mps = payments.filter(p => p.memberId === m.id && p.year == memberSelectedYear);
            const monthlyPs = mps.filter(p => p.monthKey && !p.isOther);
            const otherPs = mps.filter(p => p.isOther);
            const paidMonths = monthlyPs.map(p => p.monthKey);
            const totalMonthly = monthlyPs.reduce((s, p) => s + (p.amount || 0), 0);
            const totalOther = otherPs.reduce((s, p) => s + (p.amount || 0), 0);
            const totalIuran = ipm * 12;
            const remaining = Math.max(0, totalIuran - totalMonthly);

            document.getElementById('memberPaymentSummary').innerHTML = `
                <div class="summary-card total"><h4>Total Iuran</h4><div class="value">${formatRupiah(totalIuran)}</div></div>
                <div class="summary-card paid"><h4>Dibayar</h4><div class="value">${formatRupiah(totalMonthly)}</div></div>
                <div class="summary-card remaining"><h4>Sisa</h4><div class="value">${remaining > 0 ? formatRupiah(remaining) : 'âœ“ LUNAS'}</div></div>
                ${totalOther > 0 ? `<div class="summary-card" style="background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%);"><h4>Lainnya</h4><div class="value" style="color:var(--warning);">${formatRupiah(totalOther)}</div></div>` : ''}
            `;

            document.getElementById('memberMonthsGrid').innerHTML = MONTHS.map((mn, idx) => {
                const mk = `${memberSelectedYear}-${String(idx + 1).padStart(2, '0')}`;
                const isPaid = paidMonths.includes(mk);
                return `<div class="month-btn member-view ${isPaid ? 'paid' : ''}"><span class="month-name">${mn}</span><span class="month-amount">${formatRupiah(ipm)}</span></div>`;
            }).join('');
            document.getElementById('memberYearLabel').textContent = memberSelectedYear;

            const allMemberPayments = mps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            document.getElementById('memberPaymentHistory').innerHTML = allMemberPayments.length > 0 ? `<h4 style="margin: 18px 0 12px; color: var(--dark); font-size: 14px;"><i class="fas fa-history"></i> Riwayat</h4>${allMemberPayments.map(p => { const label = p.isOther ? (p.note || 'Lainnya') : (FULL_MONTHS[parseInt(p.monthKey?.split('-')[1]) - 1] || ''); return `<div class="payment-item"><div class="payment-item-info"><h4>${p.isOther ? '<span class="badge badge-other">Lainnya</span>' : ''} ${label}</h4><p>${formatDateTime(p.createdAt)}${p.note && !p.isOther ? ' - ' + p.note : ''}</p></div><div class="payment-item-amount">+${formatRupiah(p.amount)}</div></div>`; }).join('')}` : '';
        }

        function renderAdmins() {
            const c = document.getElementById('adminsList');
            if (admins.length === 0) { c.innerHTML = '<div class="empty-state"><i class="fas fa-user-shield"></i><h3>Tidak ada admin</h3></div>'; return; }
            c.innerHTML = admins.map(a => `<div class="admin-item"><div class="admin-info"><div class="admin-avatar">${a.name.charAt(0).toUpperCase()}</div><div><h4 style="font-size:14px;">${a.name}</h4><p style="font-size:12px;color:#64748b;">${a.phone} | ${a.nrg}</p></div></div><div style="display:flex;gap:8px;align-items:center;"><span class="badge badge-admin">Admin</span>${admins.length > 1 ? `<button class="btn btn-danger btn-icon" style="width:32px;height:32px;" onclick="confirmDelete('admin','${a.id}','${a.name}')"><i class="fas fa-trash"></i></button>` : ''}</div></div>`).join('');
        }

        function renderMembers() {
            const search = (document.getElementById('searchMember')?.value || '').toLowerCase();
            const status = document.getElementById('filterStatus')?.value || '';
            let filtered = members.filter(m => m.name.toLowerCase().includes(search) && (!status || m.status === status));
            const tbody = document.getElementById('membersList');
            if (filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="fas fa-users"></i><h3>Tidak ada data</h3></div></td></tr>`; return; }
            tbody.innerHTML = filtered.map((m, i) => {
                const { paid, total } = getMemberPaymentStats(m.id);
                const progress = total > 0 ? Math.round((paid / total) * 100) : 0;
                return `<tr><td>${i + 1}</td><td><strong>${m.name}</strong></td><td>${m.phone}</td><td>${m.nrg}</td><td><span class="badge badge-${m.status === 'ASN' ? 'asn' : 'non-asn'}">${m.status}</span></td><td>${m.school}</td><td><div style="display:flex;align-items:center;gap:6px;"><div style="flex:1;height:6px;background:#e2e8f0;border-radius:3px;min-width:40px;"><div style="height:100%;width:${progress}%;background:${progress >= 100 ? 'var(--secondary)' : 'var(--primary)'};border-radius:3px;"></div></div><span style="font-size:10px;">${progress}%</span></div></td><td><button class="btn btn-info btn-icon" style="width:32px;height:32px;" onclick="editMember('${m.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-icon" style="width:32px;height:32px;" onclick="confirmDelete('member','${m.id}','${m.name}')"><i class="fas fa-trash"></i></button></td></tr>`;
            }).join('');
        }

        function renderPaymentCards() {
            const search = (document.getElementById('searchPayment')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('filterPaymentStatus')?.value || '';
            let filtered = members.filter(m => m.name.toLowerCase().includes(search));
            if (statusFilter) filtered = filtered.filter(m => { const { paid, total } = getMemberPaymentStats(m.id); return statusFilter === 'lunas' ? paid >= total : paid < total; });
            const container = document.getElementById('paymentCardsContainer');
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><h3>Tidak ada data</h3></div>'; return; }
            container.innerHTML = filtered.map(m => {
                const ipm = m.status === 'ASN' ? settings.iuranASN : settings.iuranNonASN;
                const { paid, paidMonths } = getMemberPaymentStats(m.id);
                const otherPayments = payments.filter(p => p.memberId === m.id && p.year == selectedYear && p.isOther);
                const otherTotal = otherPayments.reduce((s, p) => s + (p.amount || 0), 0);
                const total = ipm * 12;
                const remaining = Math.max(0, total - paid);
                return `<div class="member-payment-card"><div class="member-payment-header"><div class="member-info-row"><div class="member-avatar-sm">${m.name.charAt(0).toUpperCase()}</div><div><h3 style="font-size:15px;color:var(--dark);">${m.name}</h3><p style="font-size:11px;color:#64748b;"><span class="badge badge-${m.status === 'ASN' ? 'asn' : 'non-asn'}">${m.status}</span> ${m.school}</p></div></div><div class="member-stats"><div class="member-stat"><div class="value" style="color:var(--secondary);">${formatRupiahShort(paid)}</div><div class="label">Iuran</div></div>${otherTotal > 0 ? `<div class="member-stat"><div class="value" style="color:var(--warning);">${formatRupiahShort(otherTotal)}</div><div class="label">Lain</div></div>` : ''}<div class="member-stat"><div class="value" style="color:${remaining > 0 ? 'var(--danger)' : 'var(--secondary)'};">${remaining > 0 ? formatRupiahShort(remaining) : 'âœ“'}</div><div class="label">Sisa</div></div><div class="member-stat"><div class="value">${paidMonths.length}/12</div><div class="label">Bln</div></div><button class="btn btn-primary btn-sm" style="padding:8px 14px;font-size:12px;" onclick="openPaymentModal('${m.id}')"><i class="fas fa-plus"></i></button></div></div><div class="months-grid">${MONTHS.map((mn, idx) => { const mk = `${selectedYear}-${String(idx + 1).padStart(2, '0')}`; const isPaid = paidMonths.includes(mk); return `<div class="month-btn ${isPaid ? 'paid' : ''}" onclick="${isPaid ? `cancelPaymentConfirm('${m.id}','${mk}','${m.name}')` : `quickPayMonth('${m.id}','${mk}',${ipm},'${m.name}')`}"><span class="month-name">${mn}</span><span class="month-amount">${formatRupiahShort(ipm)}</span></div>`; }).join('')}</div></div>`;
            }).join('');
        }

        function renderAllocations() {
            const totalP = payments.reduce((s, p) => s + (p.amount || 0), 0);
            const totalA = allocations.reduce((s, a) => s + (a.amount || 0), 0);
            document.getElementById('totalIncome').textContent = formatRupiah(totalP);
            document.getElementById('totalExpense').textContent = formatRupiah(totalA);
            document.getElementById('remainingKas').textContent = formatRupiah(totalP - totalA);
            const tbody = document.getElementById('allocationsList');
            if (allocations.length === 0) { tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fas fa-receipt"></i><h3>Tidak ada data</h3></div></td></tr>`; return; }
            tbody.innerHTML = allocations.map((a, i) => `<tr><td>${i + 1}</td><td>${formatDate(a.date)}</td><td>${a.description}</td><td><strong style="color:var(--danger);">-${formatRupiah(a.amount)}</strong></td><td><button class="btn btn-danger btn-icon" style="width:32px;height:32px;" onclick="confirmDelete('allocation','${a.id}','${a.description}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }

        function renderRecentActivities() {
            const tbody = document.getElementById('recentActivities');
            const recent = payments.slice(0, 12);
            if (recent.length === 0) { tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state" style="padding:25px;"><i class="fas fa-inbox"></i><p>Tidak ada data</p></div></td></tr>`; return; }
            tbody.innerHTML = recent.map(p => {
                const mem = members.find(m => m.id === p.memberId);
                let ket = p.isOther ? `<span class="badge badge-other">Lainnya</span> ${p.note || ''}` : `${FULL_MONTHS[parseInt((p.monthKey || '').split('-')[1]) - 1] || ''} ${(p.monthKey || '').split('-')[0] || ''}${p.note ? ' - ' + p.note : ''}`;
                return `<tr><td>${formatDateTime(p.createdAt)}</td><td><strong>${mem?.name || '-'}</strong></td><td>${ket}</td><td style="color:var(--secondary);font-weight:600;">+${formatRupiah(p.amount)}</td></tr>`;
            }).join('');
        }

        // ========== PAYMENT ==========
        function openPaymentModal(mid) {
            currentPaymentMember = members.find(m => m.id === mid); if (!currentPaymentMember) return;
            const ipm = currentPaymentMember.status === 'ASN' ? settings.iuranASN : settings.iuranNonASN;
            const { paidMonths } = getMemberPaymentStats(mid);
            document.getElementById('paymentMemberInfo').innerHTML = `<div style="display:flex;align-items:center;gap:12px;"><div class="member-avatar-sm">${currentPaymentMember.name.charAt(0).toUpperCase()}</div><div><h3 style="font-size:15px;">${currentPaymentMember.name}</h3><p style="font-size:12px;color:#64748b;"><span class="badge badge-${currentPaymentMember.status === 'ASN' ? 'asn' : 'non-asn'}">${currentPaymentMember.status}</span> ${formatRupiah(ipm)}/bln</p></div></div>`;
            document.getElementById('paymentMonthsGrid').innerHTML = MONTHS.map((mn, idx) => { const mk = `${selectedYear}-${String(idx + 1).padStart(2, '0')}`; const isPaid = paidMonths.includes(mk); return `<button class="month-btn ${isPaid ? 'paid' : ''}" ${isPaid ? 'disabled' : ''} onclick="${!isPaid ? `payMonthFromModal('${mk}',${ipm})` : ''}"><span class="month-name">${mn}</span><span class="month-amount">${formatRupiah(ipm)}</span></button>`; }).join('');
            document.getElementById('paymentMonth').innerHTML = `<option value="">Pilih</option>` + MONTHS.map((mn, idx) => { const mk = `${selectedYear}-${String(idx + 1).padStart(2, '0')}`; const isPaid = paidMonths.includes(mk); return `<option value="${mk}" ${isPaid ? 'disabled' : ''}>${mn} ${isPaid ? 'âœ“' : ''}</option>`; }).join('');
            document.getElementById('paymentNominal').value = ipm;
            document.getElementById('paymentNote').value = '';
            document.getElementById('otherPaymentAmount').value = '';
            document.getElementById('otherPaymentNote').value = '';
            switchPaymentTab('month');
            openModal('paymentModal');
        }

        function switchPaymentTab(tab) {
            document.querySelectorAll('.payment-tab').forEach((t, i) => t.classList.toggle('active', (tab === 'month' && i === 0) || (tab === 'nominal' && i === 1) || (tab === 'other' && i === 2)));
            document.querySelectorAll('.payment-input-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`paymentTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
        }

        async function payMonthFromModal(mk, amount) { if (!currentPaymentMember) return; await processPayment(currentPaymentMember.id, mk, amount, '', false); closeModal('paymentModal'); }
        async function saveNominalPayment() { if (!currentPaymentMember) return; const mk = document.getElementById('paymentMonth').value, amount = parseInt(document.getElementById('paymentNominal').value), note = document.getElementById('paymentNote').value.trim(); if (!mk) { showToast('Pilih bulan!', 'error'); return; } if (!amount || amount <= 0) { showToast('Nominal tidak valid!', 'error'); return; } await processPayment(currentPaymentMember.id, mk, amount, note, false); closeModal('paymentModal'); }
        async function saveOtherPayment() { if (!currentPaymentMember) return; const amount = parseInt(document.getElementById('otherPaymentAmount').value), note = document.getElementById('otherPaymentNote').value.trim(); if (!amount || amount <= 0) { showToast('Nominal tidak valid!', 'error'); return; } if (!note) { showToast('Keterangan wajib!', 'error'); return; } await processPayment(currentPaymentMember.id, null, amount, note, true); closeModal('paymentModal'); }
        function quickPayMonth(mid, mk, amount, name) { const [y, mn] = mk.split('-'); showConfirmModal('success', 'Konfirmasi', `Bayar <strong>${name}</strong> bulan <strong>${FULL_MONTHS[parseInt(mn) - 1]} ${y}</strong> sebesar <strong>${formatRupiah(amount)}</strong>?`, () => processPayment(mid, mk, amount, '', false)); }
        function cancelPaymentConfirm(mid, mk, name) { const [y, mn] = mk.split('-'); showConfirmModal('warning', 'Batalkan?', `Batalkan pembayaran <strong>${name}</strong> bulan <strong>${FULL_MONTHS[parseInt(mn) - 1]} ${y}</strong>?`, () => cancelPayment(mid, mk)); }

        async function processPayment(mid, mk, amount, note, isOther) {
            closeModal('confirmModal');
            try { const data = { memberId: mid, amount, note, year: selectedYear, createdAt: new Date().toISOString(), isOther }; if (mk) data.monthKey = mk; await db.collection('payments').add(data); await loadPayments(); updateDashboard(); updateRunningText(); renderSlideshow(); showToast('Berhasil!', 'success'); } catch (e) { console.error(e); showToast('Gagal!', 'error'); }
        }

        async function cancelPayment(mid, mk) {
            closeModal('confirmModal');
            try { const s = await db.collection('payments').where('memberId', '==', mid).where('monthKey', '==', mk).get(); for (const d of s.docs) await d.ref.delete(); await loadPayments(); updateDashboard(); updateRunningText(); renderSlideshow(); showToast('Dibatalkan', 'warning'); } catch (e) { console.error(e); showToast('Gagal!', 'error'); }
        }

        // ========== CRUD ==========
        async function saveMember() { const data = { name: document.getElementById('memberName').value.trim(), phone: document.getElementById('memberPhone').value.trim(), nrg: document.getElementById('memberNRG').value.trim(), status: document.getElementById('memberStatus').value, school: document.getElementById('memberSchool').value.trim() }; if (!data.name || !data.phone || !data.nrg || !data.status || !data.school) { showToast('Lengkapi!', 'error'); return; } if (members.some(m => m.phone === data.phone)) { showToast('HP sudah ada!', 'error'); return; } await db.collection('members').add({ ...data, createdAt: new Date().toISOString() }); closeModal('addMemberModal'); ['memberName', 'memberPhone', 'memberNRG', 'memberStatus', 'memberSchool'].forEach(id => document.getElementById(id).value = ''); await loadMembers(); renderPaymentCards(); updateDashboard(); showToast('Ditambahkan!', 'success'); }
        function editMember(id) { const m = members.find(x => x.id === id); if (!m) return; document.getElementById('editMemberId').value = id; document.getElementById('editMemberName').value = m.name; document.getElementById('editMemberPhone').value = m.phone; document.getElementById('editMemberNRG').value = m.nrg; document.getElementById('editMemberStatus').value = m.status; document.getElementById('editMemberSchool').value = m.school; openModal('editMemberModal'); }
        async function updateMember() { const id = document.getElementById('editMemberId').value; const data = { name: document.getElementById('editMemberName').value.trim(), phone: document.getElementById('editMemberPhone').value.trim(), nrg: document.getElementById('editMemberNRG').value.trim(), status: document.getElementById('editMemberStatus').value, school: document.getElementById('editMemberSchool').value.trim() }; await db.collection('members').doc(id).update(data); closeModal('editMemberModal'); await loadMembers(); renderPaymentCards(); showToast('Diupdate!', 'success'); }
        function confirmDelete(type, id, name) { showConfirmModal('danger', 'Hapus?', `Hapus <strong>${name}</strong>?`, () => executeDelete(type, id)); }
        async function executeDelete(type, id) { closeModal('confirmModal'); if (type === 'member') { await db.collection('members').doc(id).delete(); const ps = await db.collection('payments').where('memberId', '==', id).get(); for (const d of ps.docs) await d.ref.delete(); await loadMembers(); await loadPayments(); } else if (type === 'allocation') { await db.collection('allocations').doc(id).delete(); await loadAllocations(); } else if (type === 'admin') { await db.collection('admins').doc(id).delete(); await loadAdmins(); } updateDashboard(); renderSlideshow(); showToast('Dihapus!', 'success'); }
        async function saveAdmin() { const data = { name: document.getElementById('adminName').value.trim(), phone: document.getElementById('adminPhone').value.trim(), nrg: document.getElementById('adminPassword').value.trim() }; if (!data.name || !data.phone || !data.nrg) { showToast('Lengkapi!', 'error'); return; } if (admins.some(a => a.phone === data.phone)) { showToast('ID sudah ada!', 'error'); return; } await db.collection('admins').add({ ...data, createdAt: new Date().toISOString() }); closeModal('addAdminModal'); ['adminName', 'adminPhone', 'adminPassword'].forEach(id => document.getElementById(id).value = ''); await loadAdmins(); showToast('Ditambahkan!', 'success'); }
        async function saveAllocation() { const data = { date: document.getElementById('allocationDate').value, description: document.getElementById('allocationDesc').value.trim(), amount: parseInt(document.getElementById('allocationAmount').value) }; if (!data.date || !data.description || !data.amount) { showToast('Lengkapi!', 'error'); return; } const totalP = payments.reduce((s, p) => s + (p.amount || 0), 0), totalA = allocations.reduce((s, a) => s + (a.amount || 0), 0); if (data.amount > (totalP - totalA)) { showToast('Saldo kurang!', 'error'); return; } await db.collection('allocations').add({ ...data, createdAt: new Date().toISOString() }); closeModal('addAllocationModal'); document.getElementById('allocationDesc').value = ''; document.getElementById('allocationAmount').value = ''; await loadAllocations(); updateDashboard(); renderSlideshow(); showToast('Dicatat!', 'success'); }

        async function saveSettings() {
            settings.runningText = document.getElementById('settingRunningText').value;
            settings.iuranASN = parseInt(document.getElementById('settingIuranASN').value);
            settings.iuranNonASN = parseInt(document.getElementById('settingIuranNonASN').value);
            settings.activeYear = parseInt(document.getElementById('settingActiveYear').value);
            settings.showUnpaid = document.getElementById('settingShowUnpaid').checked;
            settings.font = document.getElementById('settingFont').value;
            settings.speed = parseInt(document.getElementById('settingSpeed').value);
            settings.slideshowEnabled = document.getElementById('settingSlideshow').checked;
            settings.slideSpeed = parseInt(document.getElementById('settingSlideSpeed').value);
            settings.autoSlide = document.getElementById('settingAutoSlide').checked;
            const cy = new Date().getFullYear();
            for (let y = cy - 3; y <= cy + 1; y++) { const cb = document.getElementById(`yearVisible${y}`); if (cb) settings.visibleYears[y] = cb.checked; }
            await db.collection('settings').doc('app').set(settings);
            selectedYear = settings.activeYear; memberSelectedYear = settings.activeYear;
            initYearTabs(); initMemberYearTabs(); applySettings(); updateRunningText(); renderPaymentCards(); renderMembers(); updateDashboard(); renderSlideshow();
            if (settings.autoSlide && settings.slideshowEnabled) startSlideshow(); else stopSlideshow();
            showToast('Disimpan!', 'success');
        }

        function updateDashboard() { const totalP = payments.reduce((s, p) => s + (p.amount || 0), 0), totalA = allocations.reduce((s, a) => s + (a.amount || 0), 0); let lunas = 0, belum = 0; members.forEach(m => { const { paid, total } = getMemberPaymentStats(m.id); if (paid >= total) lunas++; else belum++; }); document.getElementById('totalKas').textContent = formatRupiah(totalP - totalA); document.getElementById('totalMember').textContent = members.length; document.getElementById('totalLunas').textContent = lunas; document.getElementById('totalBelumLunas').textContent = belum; }
        function updateRunningText() { let text = settings.runningText; if (settings.showUnpaid) { const list = []; members.forEach(m => { const { paid, total } = getMemberPaymentStats(m.id); if (paid < total) list.push(`${m.name} (${formatRupiah(total - paid)})`); }); if (list.length > 0) text += ` âš ï¸ BELUM LUNAS: ${list.join(' â€¢ ')}`; } document.getElementById('runningTextContent').textContent = text; const el = document.getElementById('runningTextElement'); el.className = `running-text ${settings.font || 'font-poppins'}`; el.style.animationDuration = `${settings.speed || 30}s`; }
        function generateReport() { const totalP = payments.reduce((s, p) => s + (p.amount || 0), 0), totalA = allocations.reduce((s, a) => s + (a.amount || 0), 0), kas = totalP - totalA; let lunas = 0, belumList = []; members.forEach(m => { const { paid, total } = getMemberPaymentStats(m.id); if (paid >= total) lunas++; else belumList.push({ name: m.name, sisa: total - paid }); }); document.getElementById('reportContent').innerHTML = `<div class="card"><div class="card-body" style="text-align:center;padding:35px;"><h2 style="font-size:20px;"><i class="fas fa-mosque" style="color:var(--primary);"></i> LAPORAN KEUANGAN</h2><h3 style="color:var(--primary);font-size:16px;">KKG PAI KECAMATAN NAGREG</h3><p style="color:#64748b;font-size:13px;">Tahun ${selectedYear}</p></div></div><div class="stats-grid" style="margin:20px 0;"><div class="stat-card kas"><div class="icon"><i class="fas fa-arrow-down"></i></div><h3>${formatRupiah(totalP)}</h3><p>Pemasukan</p></div><div class="stat-card unpaid"><div class="icon"><i class="fas fa-arrow-up"></i></div><h3>${formatRupiah(totalA)}</h3><p>Pengeluaran</p></div><div class="stat-card member"><div class="icon"><i class="fas fa-wallet"></i></div><h3>${formatRupiah(kas)}</h3><p>Saldo</p></div></div><div class="card"><div class="card-header"><h2><i class="fas fa-users"></i> Statistik</h2></div><div class="card-body"><table><tr><td>Total Anggota</td><td><strong>${members.length}</strong></td></tr><tr><td>Lunas</td><td><span class="badge badge-lunas">${lunas}</span></td></tr><tr><td>Belum Lunas</td><td><span class="badge badge-belum">${belumList.length}</span></td></tr></table></div></div>`; }

        function formatRupiah(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0); }
        function formatRupiahShort(n) { if (n >= 1000000) return 'Rp' + (n / 1000000).toFixed(1) + 'jt'; if (n >= 1000) return 'Rp' + (n / 1000) + 'K'; return formatRupiah(n); }
        function formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }); }
        function formatDateTime(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showConfirmModal(type, title, msg, fn) { const icons = { success: 'fa-check-circle', danger: 'fa-exclamation-triangle', warning: 'fa-question-circle' }; document.getElementById('confirmIcon').className = `confirm-icon ${type}`; document.getElementById('confirmIcon').innerHTML = `<i class="fas ${icons[type]}"></i>`; document.getElementById('confirmTitle').textContent = title; document.getElementById('confirmMessage').innerHTML = msg; document.getElementById('confirmBtn').className = `btn btn-${type === 'danger' ? 'danger' : 'success'} btn-sm`; document.getElementById('confirmBtn').onclick = fn; openModal('confirmModal'); }
        function showToast(msg, type = 'success') { const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' }; const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<i class="fas ${icons[type]}"></i><span>${msg}</span>`; document.getElementById('toastContainer').appendChild(t); setTimeout(() => { t.style.animation = 'toastIn 0.4s ease reverse'; setTimeout(() => t.remove(), 400); }, 3500); }
    </script>
</body>
</html>
